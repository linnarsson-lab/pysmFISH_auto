<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 6.6.0" />
    <title>pysmFISH.utils API documentation</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2264%22%20height%3D%2264%22%20viewBox%3D%2244.5%202.5%2015%2015%22%3E%3Cpath%20d%3D%22M49.351%2021.041c-.233-.721-.546-2.408-.772-4.076-.042-.09-.067-.187-.046-.288-.166-1.347-.277-2.625-.241-3.351-1.378-1.008-2.271-2.586-2.271-4.362%200-.976.272-1.935.788-2.774.057-.094.122-.18.184-.268-.033-.167-.052-.339-.052-.516%200-1.477%201.202-2.679%202.679-2.679.791%200%201.496.352%201.987.9a6.3%206.3%200%200%201%201.001.029c.492-.564%201.207-.929%202.012-.929%201.477%200%202.679%201.202%202.679%202.679a2.65%202.65%200%200%201-.269%201.148c.383.747.595%201.572.595%202.41%200%202.311-1.507%204.29-3.635%205.107.037.699.147%202.27.423%203.294l.137.461c.156%202.136-4.612%205.166-5.199%203.215zm.127-4.919a4.78%204.78%200%200%200%20.775-.584c-.172-.115-.505-.254-.88-.378zm.331%202.302l.828-.502c-.202-.143-.576-.328-.984-.49zm.45%202.157l.701-.403c-.214-.115-.536-.249-.891-.376l.19.779zM49.13%204.141c0%20.152.123.276.276.276s.275-.124.275-.276-.123-.276-.276-.276-.275.124-.275.276zm.735-.389a1.15%201.15%200%200%201%20.314.783%201.16%201.16%200%200%201-1.162%201.162c-.457%200-.842-.27-1.032-.653-.026.117-.042.238-.042.362a1.68%201.68%200%200%200%201.679%201.679%201.68%201.68%200%200%200%201.679-1.679c0-.843-.626-1.535-1.436-1.654zm3.076%201.654a1.68%201.68%200%200%200%201.679%201.679%201.68%201.68%200%200%200%201.679-1.679c0-.037-.009-.072-.011-.109-.21.3-.541.508-.935.508a1.16%201.16%200%200%201-1.162-1.162%201.14%201.14%200%200%201%20.474-.912c-.015%200-.03-.005-.045-.005-.926.001-1.679.754-1.679%201.68zm1.861-1.265c0%20.152.123.276.276.276s.275-.124.275-.276-.123-.276-.276-.276-.275.124-.275.276zm1.823%204.823c0-.52-.103-1.035-.288-1.52-.466.394-1.06.64-1.717.64-1.144%200-2.116-.725-2.499-1.738-.383%201.012-1.355%201.738-2.499%201.738-.867%200-1.631-.421-2.121-1.062-.307.605-.478%201.267-.478%201.942%200%202.486%202.153%204.51%204.801%204.51s4.801-2.023%204.801-4.51zm-3.032%209.156l-.146-.492c-.276-1.02-.395-2.457-.444-3.268a6.11%206.11%200%200%201-1.18.115%206.01%206.01%200%200%201-2.536-.562l.006.175c.802.215%201.848.612%202.021%201.25.079.295-.021.601-.274.837l-.598.501c.667.304%201.243.698%201.311%201.179.02.144.022.507-.393.787l-.564.365c1.285.521%201.361.96%201.381%201.126.018.142.011.496-.427.746l-.854.489c.064-1.19%201.985-2.585%202.697-3.248zM49.34%209.925c0-.667%201-.667%201%200%200%20.653.818%201.205%201.787%201.205s1.787-.552%201.787-1.205c0-.667%201-.667%201%200%200%201.216-1.25%202.205-2.787%202.205s-2.787-.989-2.787-2.205zm-.887-7.633c-.093.077-.205.114-.317.114a.5.5%200%200%201-.318-.886L49.183.397a.5.5%200%200%201%20.703.068.5.5%200%200%201-.069.703zm7.661-.065c-.086%200-.173-.022-.253-.068l-1.523-.893c-.575-.337-.069-1.2.506-.863l1.523.892a.5.5%200%200%201%20.179.685c-.094.158-.261.247-.432.247z%22%20fill%3D%22%233bb300%22/%3E%3C/svg%3E"/>


<style type="text/css">/*! * Bootstrap Reboot v5.0.0-beta1 (https://getbootstrap.com/) * Copyright 2011-2020 The Bootstrap Authors * Copyright 2011-2020 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}[tabindex="-1"]:focus:not(:focus-visible){outline:0!important}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus{outline:dotted 1px;outline:-webkit-focus-ring-color auto 5px}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
<style type="text/css">/*! pygments syntax highlighting */pre{line-height:125%;}td.linenos pre{color:#000000; background-color:#f0f0f0; padding-left:5px; padding-right:5px;}span.linenos{color:#000000; background-color:#f0f0f0; padding-left:5px; padding-right:5px;}td.linenos pre.special{color:#000000; background-color:#ffffc0; padding-left:5px; padding-right:5px;}span.linenos.special{color:#000000; background-color:#ffffc0; padding-left:5px; padding-right:5px;}.pdoc .hll{background-color:#ffffcc}.pdoc{background:#f8f8f8;}.pdoc .c{color:#408080; font-style:italic}.pdoc .err{border:1px solid #FF0000}.pdoc .k{color:#008000; font-weight:bold}.pdoc .o{color:#666666}.pdoc .ch{color:#408080; font-style:italic}.pdoc .cm{color:#408080; font-style:italic}.pdoc .cp{color:#BC7A00}.pdoc .cpf{color:#408080; font-style:italic}.pdoc .c1{color:#408080; font-style:italic}.pdoc .cs{color:#408080; font-style:italic}.pdoc .gd{color:#A00000}.pdoc .ge{font-style:italic}.pdoc .gr{color:#FF0000}.pdoc .gh{color:#000080; font-weight:bold}.pdoc .gi{color:#00A000}.pdoc .go{color:#888888}.pdoc .gp{color:#000080; font-weight:bold}.pdoc .gs{font-weight:bold}.pdoc .gu{color:#800080; font-weight:bold}.pdoc .gt{color:#0044DD}.pdoc .kc{color:#008000; font-weight:bold}.pdoc .kd{color:#008000; font-weight:bold}.pdoc .kn{color:#008000; font-weight:bold}.pdoc .kp{color:#008000}.pdoc .kr{color:#008000; font-weight:bold}.pdoc .kt{color:#B00040}.pdoc .m{color:#666666}.pdoc .s{color:#BA2121}.pdoc .na{color:#7D9029}.pdoc .nb{color:#008000}.pdoc .nc{color:#0000FF; font-weight:bold}.pdoc .no{color:#880000}.pdoc .nd{color:#AA22FF}.pdoc .ni{color:#999999; font-weight:bold}.pdoc .ne{color:#D2413A; font-weight:bold}.pdoc .nf{color:#0000FF}.pdoc .nl{color:#A0A000}.pdoc .nn{color:#0000FF; font-weight:bold}.pdoc .nt{color:#008000; font-weight:bold}.pdoc .nv{color:#19177C}.pdoc .ow{color:#AA22FF; font-weight:bold}.pdoc .w{color:#bbbbbb}.pdoc .mb{color:#666666}.pdoc .mf{color:#666666}.pdoc .mh{color:#666666}.pdoc .mi{color:#666666}.pdoc .mo{color:#666666}.pdoc .sa{color:#BA2121}.pdoc .sb{color:#BA2121}.pdoc .sc{color:#BA2121}.pdoc .dl{color:#BA2121}.pdoc .sd{color:#BA2121; font-style:italic}.pdoc .s2{color:#BA2121}.pdoc .se{color:#BB6622; font-weight:bold}.pdoc .sh{color:#BA2121}.pdoc .si{color:#BB6688; font-weight:bold}.pdoc .sx{color:#008000}.pdoc .sr{color:#BB6688}.pdoc .s1{color:#BA2121}.pdoc .ss{color:#19177C}.pdoc .bp{color:#008000}.pdoc .fm{color:#0000FF}.pdoc .vc{color:#19177C}.pdoc .vg{color:#19177C}.pdoc .vi{color:#19177C}.pdoc .vm{color:#19177C}.pdoc .il{color:#666666}</style>
<style type="text/css">/*! pdoc */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f7f7f7;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}body{background-color:var(--pdoc-background);}html, body{width:100%;height:100%;}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main{padding:2rem 3vw;}.git-button{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}#navtoggle{display:none;}}#togglestate{display:none;}nav.pdoc{--pad:1.75rem;--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent }nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc li{display:block;margin:0;padding:.2rem 0 .2rem var(--indent);transition:all 100ms;}nav.pdoc > div > ul > li{padding-left:0;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}html, main{scroll-behavior:smooth;}.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3, .pdoc h4{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{background-color:var(--code);border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--code);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.pdoc details{--shift:-40px;text-align:right;margin-top:var(--shift);margin-bottom:calc(0px - var(--shift));clear:both;filter:opacity(1);}.pdoc details:not([open]){height:0;overflow:visible;}.pdoc details > summary{font-size:.75rem;cursor:pointer;color:var(--muted);border-width:0;padding:0 .7em;display:inline-block;display:inline list-item;user-select:none;}.pdoc details > summary:focus{outline:0;}.pdoc details > div{margin-top:calc(0px - var(--shift) / 2);text-align:left;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc > section:first-of-type > .docstring{margin-bottom:3rem;}.pdoc .docstring pre{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc .headerlink{position:absolute;width:0;margin-left:-1.5rem;line-height:1.4rem;font-size:1.5rem;font-weight:normal;transition:all 100ms ease-in-out;opacity:0;}.pdoc .attr > .headerlink{margin-left:-2.5rem;}.pdoc *:hover > .headerlink,.pdoc *:target > .attr > .headerlink{opacity:1;}.pdoc .attr{color:var(--text);margin:1rem 0 .5rem;padding:.4rem 5rem .4rem 1rem;background-color:var(--accent);}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{white-space:pre-wrap;}.pdoc .annotation{color:var(--annotation);}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}</style>
</head>
<body>        <nav class="pdoc">
            <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
            <input id="togglestate" type="checkbox">
            <div>
                        <a class="pdoc-button module-list-button" href="../pysmFISH.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                            &nbsp;pysmFISH</a>




                    <h2>API Documentation</h2>
                        <ul class="memberlist">
            <li>
                    <a class="function" href="#free_space">free_space</a>
            </li>
            <li>
                    <a class="function" href="#create_folder_structure">create_folder_structure</a>
            </li>
            <li>
                    <a class="function" href="#collect_processing_files">collect_processing_files</a>
            </li>
            <li>
                    <a class="function" href="#sort_data_into_folders">sort_data_into_folders</a>
            </li>
            <li>
                    <a class="function" href="#create_dark_img">create_dark_img</a>
            </li>
            <li>
                    <a class="function" href="#sorting_grps">sorting_grps</a>
            </li>
            <li>
                    <a class="function" href="#sorting_grps_for_fov_processing">sorting_grps_for_fov_processing</a>
            </li>
            <li>
                    <a class="function" href="#create_dir">create_dir</a>
            </li>
            <li>
                    <a class="function" href="#register_images">register_images</a>
            </li>
            <li>
                    <a class="function" href="#combine_rounds_images">combine_rounds_images</a>
            </li>
            <li>
                    <a class="function" href="#combine_filtered_images">combine_filtered_images</a>
            </li>
            <li>
                    <a class="function" href="#register_combined_rounds_images">register_combined_rounds_images</a>
            </li>
            <li>
                    <a class="function" href="#copytree">copytree</a>
            </li>
            <li>
                    <a class="function" href="#not_run_counting_sorted_grps">not_run_counting_sorted_grps</a>
            </li>
            <li>
                    <a class="function" href="#convert_to_uint16_full_float64_range">convert_to_uint16_full_float64_range</a>
            </li>
            <li>
                    <a class="function" href="#convert_to_uint16">convert_to_uint16</a>
            </li>
            <li>
                    <a class="function" href="#convert_from_uint16_to_float64">convert_from_uint16_to_float64</a>
            </li>
            <li>
                    <a class="function" href="#load_pipeline_config_file">load_pipeline_config_file</a>
            </li>
            <li>
                    <a class="function" href="#load_running_analysis_config_file">load_running_analysis_config_file</a>
            </li>
            <li>
                    <a class="function" href="#modify_images_config">modify_images_config</a>
            </li>
            <li>
                    <a class="function" href="#create_stringency_selection_fov_yaml">create_stringency_selection_fov_yaml</a>
            </li>
            <li>
                    <a class="function" href="#create_specific_fov_counting_thr_yaml">create_specific_fov_counting_thr_yaml</a>
            </li>
            <li>
                    <a class="function" href="#select_dir">select_dir</a>
            </li>
            <li>
                    <a class="class" href="#OptionEatAll">OptionEatAll</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#OptionEatAll.__init__">OptionEatAll</a>
                        </li>
                        <li>
                                <a class="function" href="#OptionEatAll.add_to_parser">add_to_parser</a>
                        </li>
                </ul>

            </li>
    </ul>


                    <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev">
                        built with <span class="visually-hidden">pdoc</span><img
                            alt="pdoc logo"
                            src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
                    </a>
            </div>
        </nav>
    <main class="pdoc">
            <section>
                    <h1 class="modulename">
<a href="./../pysmFISH.html">pysmFISH</a><wbr>.utils    </h1>

                
                        <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">click</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">nd2reader</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">img_as_float64</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">fourier_shift</span>

<span class="kn">from</span> <span class="nn">pysmFISH.logger_utils</span> <span class="kn">import</span> <span class="n">selected_logger</span>

<span class="k">def</span> <span class="nf">free_space</span><span class="p">(</span><span class="n">hd_path</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">min_free_space</span><span class="p">:</span><span class="nb">int</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function used to determine if there is enough space in the</span>
<span class="sd">    HD where the experiment will be processed</span>

<span class="sd">    Args:</span>
<span class="sd">    -----</span>
<span class="sd">        hd_path:str</span>
<span class="sd">            pathway of the target HD where the processing will be run</span>
<span class="sd">        min_free_space:int</span>
<span class="sd">            minimum space required for processing in Gb (ex: 1000)</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">        True/False: bool</span>
<span class="sd">            True if there is enough free space for running the experiment</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">selected_logger</span><span class="p">()</span>
    <span class="n">total</span><span class="p">,</span> <span class="n">used</span><span class="p">,</span> <span class="n">free</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">disk_usage</span><span class="p">(</span><span class="n">hd_path</span><span class="p">)</span>
    <span class="n">free_space_giga</span> <span class="o">=</span> <span class="n">free</span> <span class="o">//</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">30</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">free_space_giga</span> <span class="o">&lt;=</span> <span class="n">min_free_space</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Free space in the HD: </span><span class="si">{</span><span class="n">free_space_giga</span><span class="si">}</span><span class="s1"> Gb data cannot be transferred,</span><span class="se">\</span>
<span class="s1">                        not enough space on the HD&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Free space in the HD: </span><span class="si">{</span><span class="n">free_space_giga</span><span class="si">}</span><span class="s1"> Gb data can be transferred&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>



<span class="k">def</span> <span class="nf">create_folder_structure</span><span class="p">(</span><span class="n">experiment_fpath</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="n">run_type</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class used to create the folder structure where to sort the files</span>
<span class="sd">    generated by the machines and the saving the data created during the</span>
<span class="sd">    processing. It creates the backbone structure common to all analysis</span>

<span class="sd">    FOLDER STRUCTURE</span>
<span class="sd">    - original_robofish_logs: contains all the original robofish logs.</span>
<span class="sd">    - extra_files: contains the extra files acquired during imaging.</span>
<span class="sd">    - extra_processing_data: contains extra files used in the analysis </span>
<span class="sd">                                                like the dark images for flat field correction.</span>
<span class="sd">    - pipeline_config: contains all the configuration files.</span>
<span class="sd">    - raw_data: contains the renamed .nd2 files and the corresponding </span>
<span class="sd">                        pickle configuration files. It is the directory that is </span>
<span class="sd">                        backed up on the server.</span>
<span class="sd">    - output_figures: contains the reports and visualizations</span>
<span class="sd">    - notebooks: will contain potential notebooks used for processing the data</span>
<span class="sd">    - probes: will contains the fasta file with the probes used in the experiment</span>
<span class="sd">    - tmp: save temporary data</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        experiment_fpath: str</span>
<span class="sd">            folder path of the experiment</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">selected_logger</span><span class="p">()</span>
    <span class="n">experiment_fpath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">experiment_fpath</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">run_type</span> <span class="o">==</span> <span class="s1">&#39;new&#39;</span><span class="p">:</span>

        <span class="n">folders_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;raw_data&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;original_robofish_logs&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;extra_processing_data&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;extra_files&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;pipeline_config&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;output_figures&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;notebooks&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;probes&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;tmp&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;logs&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;results&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;microscope_tiles_coords&#39;</span><span class="p">]</span>
        <span class="n">subfolders_tmp</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;raw_counts&#39;</span><span class="p">,</span><span class="s1">&#39;filtered_images&#39;</span><span class="p">,</span><span class="s1">&#39;registered_counts&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;combined_rounds_images&#39;</span><span class="p">]</span>
    
    <span class="k">else</span><span class="p">:</span>
        <span class="n">folders_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;extra_processing_data&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;pipeline_config&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;output_figures&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;probes&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;tmp&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;logs&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;results&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;microscope_tiles_coords&#39;</span><span class="p">]</span>
        <span class="n">subfolders_tmp</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;raw_counts&#39;</span><span class="p">,</span><span class="s1">&#39;filtered_images&#39;</span><span class="p">,</span><span class="s1">&#39;registered_counts&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;combined_rounds_images&#39;</span><span class="p">]</span>
    
    <span class="k">for</span> <span class="n">folder_name</span> <span class="ow">in</span> <span class="n">folders_list</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">experiment_fpath</span> <span class="o">/</span> <span class="n">folder_name</span> <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">folder_name</span><span class="si">}</span><span class="s1"> already exist&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">experiment_fpath</span> <span class="o">/</span> <span class="n">folder_name</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">experiment_fpath</span> <span class="o">/</span> <span class="n">folder_name</span><span class="p">,</span><span class="mo">0o777</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">folder_name</span> <span class="ow">in</span> <span class="n">subfolders_tmp</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;tmp&#39;</span> <span class="o">/</span> <span class="n">folder_name</span> <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">folder_name</span><span class="si">}</span><span class="s1"> already exist&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;tmp&#39;</span> <span class="o">/</span> <span class="n">folder_name</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;tmp&#39;</span> <span class="o">/</span> <span class="n">folder_name</span><span class="p">,</span><span class="mo">0o777</span><span class="p">)</span>



<span class="k">def</span> <span class="nf">collect_processing_files</span><span class="p">(</span><span class="n">experiment_fpath</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">experiment_info</span><span class="p">:</span><span class="n">Dict</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Task used to sort the files in the experiment folder and</span>
<span class="sd">    gather the extra files required for the processing</span>
<span class="sd">    </span>
<span class="sd">    - instrument_name_dark_img for field correction</span>
<span class="sd">    - codebook if the experiment is barcoded</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">selected_logger</span><span class="p">()</span>

    <span class="n">experiment_fpath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">experiment_fpath</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">machine</span> <span class="o">=</span> <span class="n">experiment_info</span><span class="p">[</span><span class="s1">&#39;Machine&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
        <span class="n">machine</span> <span class="o">=</span> <span class="s1">&#39;NOT_DEFINED&#39;</span>

    <span class="c1"># This step can be also be removed in case we won&#39;t use the processing env config </span>
    <span class="n">processing_env_config_fpath</span> <span class="o">=</span> <span class="n">experiment_fpath</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s1">&#39;config_db&#39;</span> <span class="o">/</span> <span class="s1">&#39;processing_env_config.yaml&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">processing_env_config_fpath</span><span class="p">,</span> <span class="p">(</span><span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;pipeline_config&#39;</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;missing pipeline env config file&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;missing pipeline env config file&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># This step will be modified when the rpobes will be stored in shoji</span>
        <span class="n">probes_fpath</span> <span class="o">=</span> <span class="n">experiment_fpath</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s1">&#39;probes_sets&#39;</span> <span class="o">/</span> <span class="p">(</span><span class="n">experiment_info</span><span class="p">[</span><span class="s1">&#39;Probe_FASTA_name&#39;</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">probes_fpath</span><span class="p">,</span> <span class="p">(</span><span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;probes&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;missing probes set file&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;missing probes set file&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># This step will be modified when the codebook will be stored in shoji</span>
            <span class="k">if</span> <span class="s1">&#39;barcoded&#39;</span> <span class="ow">in</span> <span class="n">experiment_info</span><span class="p">[</span><span class="s1">&#39;Experiment_type&#39;</span><span class="p">]:</span>
                <span class="n">codebooks_folder</span> <span class="o">=</span> <span class="n">experiment_fpath</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s1">&#39;codebooks&#39;</span>
                <span class="n">codebook_code</span> <span class="o">=</span> <span class="n">experiment_info</span><span class="p">[</span><span class="s1">&#39;Codebook&#39;</span><span class="p">]</span>
                
                <span class="n">codebook_fpath</span> <span class="o">=</span> <span class="n">codebooks_folder</span> <span class="o">/</span> <span class="n">codebook_code</span>
                
                <span class="c1"># Create codebook folder in the experiment folder</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;codebook&#39;</span> <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;codebook folder already exist&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;codebook&#39;</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;codebook&#39;</span><span class="p">,</span><span class="mo">0o777</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">codebook_fpath</span><span class="p">,</span> <span class="p">(</span><span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;codebook&#39;</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;codebook is missing&#39;</span><span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;codebook is missing&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">sort_data_into_folders</span><span class="p">(</span><span class="n">experiment_fpath</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="n">experiment_info</span><span class="p">:</span><span class="n">Dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function used to sort the files created by the machine and contained </span>
<span class="sd">    in the experiment folder in the subfolders</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        experiment_fpath: str</span>
<span class="sd">            location of the folder to be processed</span>
<span class="sd">        experiment_info: ordered dict</span>
<span class="sd">            ordered dict with the parsed info generated by the instrument</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">logger</span> <span class="o">=</span> <span class="n">selected_logger</span><span class="p">()</span>
    <span class="n">experiment_fpath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">experiment_fpath</span><span class="p">)</span>

    <span class="c1"># Move the robofish generated logs</span>
    <span class="n">robofish_logs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">experiment_fpath</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*.log&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">robofish_logs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">log</span> <span class="ow">in</span> <span class="n">robofish_logs</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">log</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span> <span class="p">(</span><span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;original_robofish_logs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;moved </span><span class="si">{</span><span class="n">log</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s1"> into original_robofish_logs&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;there are no original robofish logs in the experiment folder&#39;</span><span class="p">)</span>


    <span class="c1"># Move the crosses images</span>
    <span class="n">crosses_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">experiment_fpath</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*_cross.nd2&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">crosses_files</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">cross</span> <span class="ow">in</span> <span class="n">crosses_files</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">cross</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span> <span class="p">(</span><span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;extra_files&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;moved </span><span class="si">{</span><span class="n">cross</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s1"> into extra_files&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;there are no crosses images in the experiment folders&#39;</span><span class="p">)</span>
    
    <span class="c1"># Move the coords files</span>
    <span class="n">coords_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">experiment_fpath</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*.xml&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords_files</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">coords_files</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">coord</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span> <span class="p">(</span><span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;extra_files&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;moved </span><span class="si">{</span><span class="n">coord</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s1"> into extra_files&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;there are no coords files in the experiment folders&#39;</span><span class="p">)</span>
    
    <span class="c1"># Move the fresh nuclei file for eel</span>
    <span class="k">if</span> <span class="s1">&#39;eel&#39;</span> <span class="ow">in</span> <span class="n">experiment_info</span><span class="p">[</span><span class="s1">&#39;Experiment_type&#39;</span><span class="p">]:</span>
        <span class="n">nuclei_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">experiment_fpath</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*ChannelEuropium_Cy3*&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nuclei_files</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;fresh_nuclei&#39;</span> <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;fresh_nuclei already exist&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;fresh_nuclei&#39;</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;fresh_nuclei&#39;</span><span class="p">,</span><span class="mo">0o777</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">nuclei</span> <span class="ow">in</span> <span class="n">nuclei_files</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">nuclei</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span> <span class="p">(</span><span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;fresh_nuclei&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;moved </span><span class="si">{</span><span class="n">nuclei</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s1"> into fresh nuclei&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The experiment does not have images of fresh nuclei&#39;</span><span class="p">)</span>
        
        <span class="n">large_views</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">experiment_fpath</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*ChannelDAPI*&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">large_views</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">large_view</span> <span class="ow">in</span> <span class="n">large_views</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">large_view</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span> <span class="p">(</span><span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;extra_files&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;moved </span><span class="si">{</span><span class="n">large_view</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s1"> into extra_files&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The experiment does not have large view images of fresh nuclei&#39;</span><span class="p">)</span>

    <span class="c1"># move remaining .nd2 files</span>
    <span class="n">all_nd2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">experiment_fpath</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*.nd2&#39;</span><span class="p">))</span>
    <span class="n">remaining</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">all_nd2</span> <span class="k">if</span> <span class="s1">&#39;Count&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">el</span><span class="o">.</span><span class="n">stem</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">remaining</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">fremaining</span> <span class="ow">in</span> <span class="n">remaining</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">fremaining</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span> <span class="p">(</span><span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;extra_files&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;moved </span><span class="si">{</span><span class="n">fremaining</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s1"> into extra_files&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;There are no extra files to be moved&#39;</span><span class="p">)</span>



<span class="k">def</span> <span class="nf">create_dark_img</span><span class="p">(</span><span class="n">experiment_fpath</span><span class="p">,</span><span class="n">experiment_info</span><span class="p">):</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">selected_logger</span><span class="p">()</span>
    <span class="n">experiment_fpath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">experiment_fpath</span><span class="p">)</span>
    <span class="n">experiment_name</span> <span class="o">=</span> <span class="n">experiment_info</span><span class="p">[</span><span class="s1">&#39;EXP_name&#39;</span><span class="p">]</span>
    <span class="n">machine</span> <span class="o">=</span> <span class="n">experiment_info</span><span class="p">[</span><span class="s1">&#39;Machine&#39;</span><span class="p">]</span>
    <span class="c1"># Check if the dark image is already present</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">pres</span> <span class="o">=</span> <span class="nb">list</span><span class="p">((</span><span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;extra_processing_data&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*_dark_img.npy&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">nd2_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">((</span><span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;extra_files&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*.nd2&#39;</span><span class="p">))</span>
        <span class="n">nd2_blank</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">nd2_list</span> <span class="k">if</span> <span class="s1">&#39;Blank&#39;</span> <span class="ow">in</span> <span class="n">el</span><span class="o">.</span><span class="n">stem</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">nd2_blank</span><span class="p">:</span>
            <span class="n">nd2fh</span> <span class="o">=</span> <span class="n">nd2reader</span><span class="o">.</span><span class="n">ND2Reader</span><span class="p">(</span><span class="n">nd2_blank</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">nd2fh</span><span class="o">.</span><span class="n">bundle_axes</span> <span class="o">=</span> <span class="s1">&#39;zyx&#39;</span>
            <span class="n">nd2fh</span><span class="o">.</span><span class="n">iter_axes</span> <span class="o">=</span> <span class="s1">&#39;z&#39;</span>
            <span class="c1"># Image with single channel</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="n">nd2fh</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># I can collect just one z because error of the reader</span>
            <span class="c1"># that created both z and t planes</span>
            <span class="n">dark_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">nd2fh</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">dark_img</span> <span class="o">=</span> <span class="n">dark_img</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;extra_processing_data&#39;</span> <span class="o">/</span> <span class="p">(</span><span class="n">experiment_name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">machine</span> <span class="o">+</span> <span class="s1">&#39;_dark_img.npy&#39;</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">dark_img</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Created dark image&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;the Blank .nd2 for the dark image is missing&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;the dark image is already present&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">sorting_grps</span><span class="p">(</span><span class="n">grps</span><span class="p">,</span> <span class="n">experiment_info</span><span class="p">,</span> <span class="n">analysis_parameters</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function used to separate the group names according to </span>
<span class="sd">    the processing type</span>
<span class="sd">    Args:</span>
<span class="sd">    -----</span>
<span class="sd">        grps = zarr.hierarchy.Group</span>
<span class="sd">            consolidate hierarchy zarr groups for fast access to metadata</span>
<span class="sd">        experiment_info: ordered dict</span>
<span class="sd">            ordered dict with the parsed info generated by the instrument</span>
<span class="sd">        analysis_parameters: dict</span>
<span class="sd">            dict with all the parameters to use for analysis  </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">        fish_grp: list</span>
<span class="sd">            list of the groups containing fish images</span>
<span class="sd">        fish_selected_parameters: list</span>
<span class="sd">            matching parameters used for fish analysis</span>
<span class="sd">        beads_grp: list</span>
<span class="sd">            list of the groups containing beads images</span>
<span class="sd">        beads_selected_parameters: list</span>
<span class="sd">            matching parameters used for beads analysis</span>
<span class="sd">        staining_grp: list</span>
<span class="sd">            list of the groups containing IF/staining images</span>
<span class="sd">        staining_selected_parameters:list</span>
<span class="sd">            matching parameters used for IF/staining analysis</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">fish_grp</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">beads_grp</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">staining_grp</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">grps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">grp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;stitching_channel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">grp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">]:</span>
            <span class="n">beads_grp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;_ST&#39;</span> <span class="ow">in</span> <span class="n">grp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;target_name&#39;</span><span class="p">]:</span>
            <span class="n">staining_grp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fish_grp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">experiment_info</span><span class="p">[</span><span class="s1">&#39;Stitching_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;small-beads&#39;</span><span class="p">:</span>
        <span class="n">beads_selected_parameters</span>  <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;small-beads&#39;</span><span class="p">]</span>
        <span class="n">beads_selected_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">experiment_info</span><span class="p">[</span><span class="s1">&#39;Stitching_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;large-beads&#39;</span><span class="p">:</span>
        <span class="n">beads_selected_parameters</span>  <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;large-beads&#39;</span><span class="p">]</span>
        <span class="n">beads_selected_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">experiment_info</span><span class="p">[</span><span class="s1">&#39;Stitching_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;both-beads&#39;</span><span class="p">:</span>
        <span class="n">beads_selected_parameters</span>  <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;both-beads&#39;</span><span class="p">]</span>
        <span class="n">beads_selected_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">experiment_info</span><span class="p">[</span><span class="s1">&#39;Stitching_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;nuclei&#39;</span> <span class="p">:</span>
        <span class="n">beads_selected_parameters</span>  <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;nuclei&#39;</span><span class="p">]</span>
        <span class="n">beads_selected_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Wrong stitching type in the experiment file&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Wrong stitching type in the experiment file&#39;</span><span class="p">)</span>
    
    <span class="n">fish_selected_parameters</span> <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;fish&#39;</span><span class="p">]</span>
    <span class="n">fish_selected_parameters</span><span class="p">[</span><span class="s1">&#39;BarcodesExtractionResolution&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;BarcodesExtractionResolution&#39;</span><span class="p">]</span>
    <span class="n">fish_selected_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span>

    <span class="n">staining_selected_parameters</span> <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;staining&#39;</span><span class="p">]</span>
    <span class="n">staining_selected_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span>

    <span class="n">combined_grps</span> <span class="o">=</span><span class="p">{</span><span class="s1">&#39;fish&#39;</span><span class="p">:(</span><span class="n">fish_grp</span><span class="p">,</span> <span class="n">fish_selected_parameters</span><span class="p">),</span>
                    <span class="s1">&#39;beads&#39;</span><span class="p">:(</span><span class="n">beads_grp</span><span class="p">,</span> <span class="n">beads_selected_parameters</span><span class="p">),</span>
                    <span class="s1">&#39;staining&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">staining_grp</span><span class="p">,</span> <span class="n">staining_selected_parameters</span><span class="p">)</span>
                    <span class="p">}</span>

    <span class="k">return</span> <span class="n">combined_grps</span>


<span class="k">def</span> <span class="nf">sorting_grps_for_fov_processing</span><span class="p">(</span><span class="n">consolidated_grp</span><span class="p">,</span> <span class="n">experiment_info</span><span class="p">,</span> <span class="n">analysis_parameters</span><span class="p">):</span>

    <span class="n">registration_channel</span> <span class="o">=</span> <span class="n">experiment_info</span><span class="p">[</span><span class="s1">&#39;StitchingChannel&#39;</span><span class="p">]</span>
    <span class="n">experiment_name</span> <span class="o">=</span>  <span class="n">experiment_info</span><span class="p">[</span><span class="s1">&#39;EXP_name&#39;</span><span class="p">]</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">experiment_name</span> <span class="o">+</span> <span class="s1">&#39;_Hybridization01_&#39;</span> <span class="o">+</span> <span class="n">registration_channel</span> <span class="o">+</span> <span class="s1">&#39;_fov_0&#39;</span>
    <span class="n">fovs</span> <span class="o">=</span> <span class="n">consolidated_grp</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;fields_of_view&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">experiment_info</span><span class="p">[</span><span class="s1">&#39;Stitching_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;small-beads&#39;</span><span class="p">:</span>
            <span class="n">registration_selected_parameters</span>  <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;small-beads&#39;</span><span class="p">]</span>
            <span class="n">registration_selected_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">experiment_info</span><span class="p">[</span><span class="s1">&#39;Stitching_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;large-beads&#39;</span><span class="p">:</span>
        <span class="n">registration_selected_parameters</span>  <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;large-beads&#39;</span><span class="p">]</span>
        <span class="n">registration_selected_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">experiment_info</span><span class="p">[</span><span class="s1">&#39;Stitching_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;both-beads&#39;</span><span class="p">:</span>
        <span class="n">registration_selected_parameters</span>  <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;both-beads&#39;</span><span class="p">]</span>
        <span class="n">registration_selected_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">experiment_info</span><span class="p">[</span><span class="s1">&#39;Stitching_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;nuclei&#39;</span> <span class="p">:</span>
        <span class="n">registration_selected_parameters</span>  <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;nuclei&#39;</span><span class="p">]</span>
        <span class="n">registration_selected_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Wrong stitching type in the experiment file&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Wrong stitching type in the experiment file&#39;</span><span class="p">)</span>

    <span class="n">fish_selected_parameters</span> <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;fish&#39;</span><span class="p">]</span>
    <span class="n">fish_selected_parameters</span><span class="p">[</span><span class="s1">&#39;BarcodesExtractionResolution&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;BarcodesExtractionResolution&#39;</span><span class="p">]</span>
    <span class="n">fish_selected_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span>

    <span class="n">staining_selected_parameters</span> <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;staining&#39;</span><span class="p">]</span>
    <span class="n">staining_selected_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span>


    <span class="c1"># Group the names by fov</span>
    <span class="n">grpd_by_fov</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">fov</span> <span class="ow">in</span> <span class="n">fovs</span><span class="p">:</span>
        <span class="n">grpd_by_fov</span><span class="p">[</span><span class="n">fov</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">grpd_by_fov</span><span class="p">[</span><span class="n">fov</span><span class="p">][</span><span class="s1">&#39;split&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">grpd_by_fov</span><span class="p">[</span><span class="n">fov</span><span class="p">][</span><span class="s1">&#39;all_names&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">consolidated_grp</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">fov</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_fov_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">grpd_by_fov</span><span class="p">[</span><span class="n">fov</span><span class="p">][</span><span class="s1">&#39;all_names&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>


    <span class="c1"># Regroup by processing type</span>
    <span class="k">for</span> <span class="n">fov</span><span class="p">,</span> <span class="n">data_dict</span> <span class="ow">in</span> <span class="n">grpd_by_fov</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">grpd_by_fov</span><span class="p">[</span><span class="n">fov</span><span class="p">][</span><span class="s1">&#39;split&#39;</span><span class="p">][</span><span class="s1">&#39;fish&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">grpd_by_fov</span><span class="p">[</span><span class="n">fov</span><span class="p">][</span><span class="s1">&#39;split&#39;</span><span class="p">][</span><span class="s1">&#39;registration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">grpd_by_fov</span><span class="p">[</span><span class="n">fov</span><span class="p">][</span><span class="s1">&#39;split&#39;</span><span class="p">][</span><span class="s1">&#39;staining&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;all_names&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">consolidated_grp</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;stitching_channel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">consolidated_grp</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">consolidated_grp</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">grpd_by_fov</span><span class="p">[</span><span class="n">fov</span><span class="p">][</span><span class="s1">&#39;split&#39;</span><span class="p">][</span><span class="s1">&#39;registration&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">grpd_by_fov</span><span class="p">[</span><span class="n">fov</span><span class="p">][</span><span class="s1">&#39;split&#39;</span><span class="p">][</span><span class="s1">&#39;registration&#39;</span><span class="p">][</span><span class="n">consolidated_grp</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">grpd_by_fov</span><span class="p">[</span><span class="n">fov</span><span class="p">][</span><span class="s1">&#39;split&#39;</span><span class="p">][</span><span class="s1">&#39;registration&#39;</span><span class="p">][</span><span class="n">consolidated_grp</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">([],</span><span class="n">registration_selected_parameters</span><span class="p">)</span>
                    <span class="n">grpd_by_fov</span><span class="p">[</span><span class="n">fov</span><span class="p">][</span><span class="s1">&#39;split&#39;</span><span class="p">][</span><span class="s1">&#39;registration&#39;</span><span class="p">][</span><span class="n">consolidated_grp</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;_ST&#39;</span> <span class="ow">in</span> <span class="n">consolidated_grp</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;target_name&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">consolidated_grp</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">grpd_by_fov</span><span class="p">[</span><span class="n">fov</span><span class="p">][</span><span class="s1">&#39;split&#39;</span><span class="p">][</span><span class="s1">&#39;staining&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">grpd_by_fov</span><span class="p">[</span><span class="n">fov</span><span class="p">][</span><span class="s1">&#39;split&#39;</span><span class="p">][</span><span class="s1">&#39;staining&#39;</span><span class="p">][</span><span class="n">consolidated_grp</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">grpd_by_fov</span><span class="p">[</span><span class="n">fov</span><span class="p">][</span><span class="s1">&#39;split&#39;</span><span class="p">][</span><span class="s1">&#39;staining&#39;</span><span class="p">][</span><span class="n">consolidated_grp</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">([],</span><span class="n">staining_selected_parameters</span><span class="p">)</span>
                    <span class="n">grpd_by_fov</span><span class="p">[</span><span class="n">fov</span><span class="p">][</span><span class="s1">&#39;split&#39;</span><span class="p">][</span><span class="s1">&#39;staining&#39;</span><span class="p">][</span><span class="n">consolidated_grp</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">consolidated_grp</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">grpd_by_fov</span><span class="p">[</span><span class="n">fov</span><span class="p">][</span><span class="s1">&#39;split&#39;</span><span class="p">][</span><span class="s1">&#39;fish&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">grpd_by_fov</span><span class="p">[</span><span class="n">fov</span><span class="p">][</span><span class="s1">&#39;split&#39;</span><span class="p">][</span><span class="s1">&#39;fish&#39;</span><span class="p">][</span><span class="n">consolidated_grp</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">grpd_by_fov</span><span class="p">[</span><span class="n">fov</span><span class="p">][</span><span class="s1">&#39;split&#39;</span><span class="p">][</span><span class="s1">&#39;fish&#39;</span><span class="p">][</span><span class="n">consolidated_grp</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">([],</span><span class="n">fish_selected_parameters</span><span class="p">)</span>
                    <span class="n">grpd_by_fov</span><span class="p">[</span><span class="n">fov</span><span class="p">][</span><span class="s1">&#39;split&#39;</span><span class="p">][</span><span class="s1">&#39;fish&#39;</span><span class="p">][</span><span class="n">consolidated_grp</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">grpd_by_fov</span>

<span class="k">def</span> <span class="nf">create_dir</span><span class="p">(</span><span class="n">dir_path</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span><span class="mo">0o777</span><span class="p">)</span>



<span class="k">def</span> <span class="nf">register_images</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">shift</span><span class="p">):</span>
        <span class="n">offset_image</span> <span class="o">=</span> <span class="n">fourier_shift</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftn</span><span class="p">(</span><span class="n">img</span><span class="p">),</span> <span class="n">shift</span><span class="p">)</span>
        <span class="n">offset_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftn</span><span class="p">(</span><span class="n">offset_image</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
        <span class="k">return</span> <span class="n">offset_image</span>


<span class="k">def</span> <span class="nf">combine_rounds_images</span><span class="p">(</span><span class="n">images_path_list</span><span class="p">,</span><span class="n">experiment_fpath</span><span class="p">,</span> <span class="n">experiment_info</span><span class="p">,</span><span class="n">all_rounds_shifts</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">experiment_fpath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">experiment_fpath</span><span class="p">)</span>
    
    <span class="n">rounds_num</span> <span class="o">=</span> <span class="n">experiment_info</span><span class="p">[</span><span class="s1">&#39;Barcode_length&#39;</span><span class="p">]</span>
    <span class="n">fov</span> <span class="o">=</span> <span class="n">images_path_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stem</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">channel</span> <span class="o">=</span> <span class="n">images_path_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stem</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">experiment_name</span> <span class="o">=</span> <span class="n">experiment_info</span><span class="p">[</span><span class="s1">&#39;EXP_name&#39;</span><span class="p">]</span>

    <span class="n">fpath_dots</span> <span class="o">=</span> <span class="n">images_path_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="p">(</span><span class="n">fpath_dots</span><span class="o">.</span><span class="n">stem</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_dots&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_filtered.pkl&#39;</span>
    <span class="n">path_img</span> <span class="o">=</span> <span class="n">fpath_dots</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s1">&#39;filtered_images&#39;</span> <span class="o">/</span> <span class="n">fname</span>
    <span class="n">img</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">path_img</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">))</span>
    <span class="n">img_stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">rounds_num</span><span class="p">,</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>

    <span class="k">for</span> <span class="n">fpath_dots</span> <span class="ow">in</span> <span class="n">images_path_list</span><span class="p">:</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="p">(</span><span class="n">fpath_dots</span><span class="o">.</span><span class="n">stem</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_dots&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_filtered.pkl&#39;</span>
        <span class="n">path_img</span> <span class="o">=</span> <span class="n">fpath_dots</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s1">&#39;filtered_images&#39;</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="n">path_img</span> <span class="o">/</span> <span class="n">fname</span>
        <span class="n">round_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;Hybridization&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">img</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">))</span>
        <span class="n">img</span><span class="p">[</span><span class="n">img</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="n">all_rounds_shifts</span><span class="p">[</span><span class="n">round_num</span><span class="p">]</span>
        <span class="n">shifted_img</span> <span class="o">=</span> <span class="n">register_images</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">shift</span><span class="p">)</span>
        <span class="n">img_stack</span><span class="p">[</span><span class="n">round_num</span><span class="o">-</span><span class="mi">1</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">shifted_img</span>

    <span class="n">fpath</span> <span class="o">=</span> <span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;tmp&#39;</span> <span class="o">/</span> <span class="s1">&#39;combined_rounds_images&#39;</span> <span class="o">/</span> <span class="p">(</span><span class="n">experiment_name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">channel</span> <span class="o">+</span> <span class="s1">&#39;_combined_img_fov_&#39;</span> <span class="o">+</span> <span class="n">fov</span> <span class="o">+</span> <span class="s1">&#39;.npy&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
        <span class="c1"># Add conversion to more compress ftype</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">img_stack</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">img_stack</span>



<span class="k">def</span> <span class="nf">combine_filtered_images</span><span class="p">(</span><span class="n">output_list</span><span class="p">,</span><span class="n">experiment_fpath</span><span class="p">,</span><span class="n">metadata</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">experiment_fpath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">experiment_fpath</span><span class="p">)</span>
     
    <span class="n">img_stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;total_rounds&#39;</span><span class="p">],</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;img_width&#39;</span><span class="p">],</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;img_height&#39;</span><span class="p">]])</span>

    <span class="k">for</span> <span class="n">img</span><span class="p">,</span> <span class="n">img_meta</span> <span class="ow">in</span> <span class="n">output_list</span><span class="p">:</span>
        <span class="n">round_num</span> <span class="o">=</span> <span class="n">img_meta</span><span class="o">.</span><span class="n">round_num</span>
        <span class="n">img_stack</span><span class="p">[</span><span class="n">round_num</span><span class="o">-</span><span class="mi">1</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">img</span>

    <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
        <span class="c1"># Add conversion to more compress ftype</span>
        <span class="n">img_meta</span> <span class="o">=</span> <span class="n">output_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">channel</span> <span class="o">=</span> <span class="n">img_meta</span><span class="o">.</span><span class="n">channel</span>
        <span class="n">fov</span> <span class="o">=</span> <span class="n">img_meta</span><span class="o">.</span><span class="n">fov_num</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;tmp&#39;</span> <span class="o">/</span> <span class="s1">&#39;combined_rounds_images&#39;</span> <span class="o">/</span> <span class="p">(</span><span class="n">experiment_name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">channel</span> <span class="o">+</span> <span class="s1">&#39;_combined_img_fov_&#39;</span> <span class="o">+</span> <span class="n">fov</span> <span class="o">+</span> <span class="s1">&#39;.npy&#39;</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">img_stack</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">img_stack</span>






<span class="k">def</span> <span class="nf">register_combined_rounds_images</span><span class="p">(</span><span class="n">combined_round_images</span><span class="p">,</span><span class="n">all_rounds_shifts</span><span class="p">):</span>
    
    <span class="n">img_stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">combined_round_images</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">round_num</span><span class="p">,</span> <span class="n">shift</span> <span class="ow">in</span> <span class="n">all_rounds_shifts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">combined_round_images</span><span class="p">[</span><span class="n">round_num</span><span class="o">-</span><span class="mi">1</span><span class="p">,:,:]</span>
        <span class="n">img</span><span class="p">[</span><span class="n">img</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">shifted_img</span> <span class="o">=</span> <span class="n">register_images</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">shift</span><span class="p">)</span>
        <span class="n">img_stack</span><span class="p">[</span><span class="n">round_num</span><span class="o">-</span><span class="mi">1</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">shifted_img</span>

    <span class="k">return</span> <span class="n">img_stack</span>

<span class="c1"># https://stackoverflow.com/questions/1868714/how-do-i-copy-an-entire-directory-of-files-into-an-existing-directory-using-pyth</span>
<span class="k">def</span> <span class="nf">copytree</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">symlinks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="n">copytree</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">symlinks</span><span class="p">,</span> <span class="n">ignore</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span> <span class="o">-</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">not_run_counting_sorted_grps</span><span class="p">(</span><span class="n">experiment_fpath</span><span class="p">,</span> <span class="n">sorted_grps</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function to identify the files not processed for counting</span>
<span class="sd">    because a failure of dask/htcondor. Identify the files that</span>
<span class="sd">    remain to be processed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">experiment_fpath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">experiment_fpath</span><span class="p">)</span>
    <span class="n">counts_fpath</span> <span class="o">=</span> <span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;tmp&#39;</span> <span class="o">/</span> <span class="s1">&#39;raw_counts&#39;</span>
    
    <span class="n">non_processed_sorted_grps</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="n">files_processed</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">counts_fpath</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*_dots.pkl&#39;</span><span class="p">))</span>
    <span class="n">files_processed</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span><span class="o">.</span><span class="n">stem</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">files_processed</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="n">grp</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span> <span class="ow">in</span> <span class="n">sorted_grps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">non_processed_grp</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">zarr_grp_name</span> <span class="ow">in</span> <span class="n">grp</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">zarr_grp_name</span> <span class="ow">in</span> <span class="n">files_processed</span><span class="p">:</span>
                <span class="n">files_processed</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">zarr_grp_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">non_processed_grp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zarr_grp_name</span><span class="p">)</span>
        <span class="n">non_processed_sorted_grps</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">non_processed_grp</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">non_processed_sorted_grps</span>






<span class="c1"># # to avoid reference for nested structures</span>
<span class="c1"># # https://stackoverflow.com/questions/13518819/avoid-references-in-pyyaml (comment)</span>
<span class="c1"># yaml.SafeDumper.ignore_aliases = lambda *args : True</span>


<span class="c1"># # to avoid reference for nested structures</span>
<span class="c1"># # https://stackoverflow.com/questions/13518819/avoid-references-in-pyyaml (comment)</span>
<span class="c1"># yaml.SafeDumper.ignore_aliases = lambda *args : True</span>

<span class="k">def</span> <span class="nf">convert_to_uint16_full_float64_range</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
    <span class="c1"># Clip the values above 1</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">image</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">.</span><span class="n">max</span>
    <span class="c1"># image[image &gt; 1] = 1</span>
    <span class="c1"># in the current processing step the images are float</span>
    <span class="c1"># but not anymore between (0,1)</span>
    <span class="c1"># Scale to the max of the uint16</span>
    <span class="n">image</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span><span class="o">.</span><span class="n">max</span>
    <span class="c1"># Round and convert to integer</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">image</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">image</span>

<span class="k">def</span> <span class="nf">convert_to_uint16</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Consider that the original images were uint16</span>
<span class="sd">    that is why i normalize for np.iinfo(np.uint16).max*1.0</span>
<span class="sd">    otherwise the values will be to small</span>
<span class="sd">    &quot;&quot;&quot;</span>
 
    <span class="n">image</span> <span class="o">=</span> <span class="n">image</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="o">*</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span><span class="o">.</span><span class="n">max</span>
    <span class="c1"># Round and convert to integer</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">image</span>

<span class="k">def</span> <span class="nf">convert_from_uint16_to_float64</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">image</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span><span class="o">.</span><span class="n">max</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">img_as_float64</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">image</span>


<span class="k">def</span> <span class="nf">load_pipeline_config_file</span><span class="p">(</span><span class="n">pipeline_config_fpath</span><span class="p">):</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">pipeline_config_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">pipeline_config_fpath</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">pipeline_config_dict</span>
    <span class="k">except</span> <span class="ne">FileExistsError</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pipeline_config_fpath</span><span class="si">}</span><span class="s1"> missing&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pipeline_config_fpath</span><span class="si">}</span><span class="s1"> missing&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pipeline_config_fpath</span><span class="si">}</span><span class="s1"> wrong pathway name&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pipeline_config_fpath</span><span class="si">}</span><span class="s1"> wrong pathway name&#39;</span><span class="p">)</span>



<span class="k">def</span> <span class="nf">load_running_analysis_config_file</span><span class="p">(</span><span class="n">experiment_fpath</span><span class="p">):</span>
    <span class="n">experiment_fpath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">experiment_fpath</span><span class="p">)</span>
    <span class="n">config_fpath</span> <span class="o">=</span> <span class="n">experiment_fpath</span> <span class="o">/</span>  <span class="s1">&#39;pipeline_config&#39;</span>
    <span class="n">running_analysis_config_fpath</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">config_fpath</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*_analysis_run.yaml&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">running_analysis_config_fpath</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;missing running analysis config file&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;missing running analysis config file&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">running_analysis_config_fpath</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;too many running analysis config file&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;too many running analysis config file&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">running_analysis_config_fpath</span> <span class="o">=</span> <span class="n">running_analysis_config_fpath</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">running_analysis_config</span> <span class="o">=</span> <span class="n">load_pipeline_config_file</span><span class="p">(</span><span class="n">running_analysis_config_fpath</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">running_analysis_config</span>



<span class="k">def</span> <span class="nf">modify_images_config</span><span class="p">(</span><span class="n">experiment_fpath</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="n">keyword</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function used to batch modify the values of the</span>
<span class="sd">    processing parameters in the images_config.yaml</span>
<span class="sd">    files</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    experiment_fpath: str</span>
<span class="sd">        path of the experiment to process</span>
<span class="sd">    keyword: str</span>
<span class="sd">        selection criteria used to process a subset of</span>
<span class="sd">        configuration files</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">experiment_fpath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">experiment_fpath</span><span class="p">)</span>
    <span class="n">pipeline_config_dpath</span> <span class="o">=</span> <span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;pipeline_config&#39;</span>

    <span class="k">for</span> <span class="n">config_fpath</span> <span class="ow">in</span> <span class="n">pipeline_config_dpath</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*_images_config.yaml&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">config_fpath</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="n">img_config_dict</span> <span class="o">=</span> <span class="n">load_pipeline_config_file</span><span class="p">(</span><span class="n">config_fpath</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">fov_name</span><span class="p">,</span> <span class="n">fov_data</span> <span class="ow">in</span> <span class="n">img_config_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">round_name</span><span class="p">,</span> <span class="n">round_data</span> <span class="ow">in</span> <span class="n">fov_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="c1"># round_data[&#39;analysis_parameters&#39;] = {}</span>
                    <span class="c1"># round_data[&#39;analysis_parameters&#39;][&#39;preprocessing&#39;] = {}</span>
                    <span class="c1"># round_data[&#39;analysis_parameters&#39;][&#39;preprocessing&#39;][&#39;flat_field_kernel&#39;] = (2,100,100)</span>
                    <span class="c1"># round_data[&#39;analysis_parameters&#39;][&#39;preprocessing&#39;][&#39;filtering_small_kernel&#39;] = (1,8,8)</span>
                    <span class="c1"># round_data[&#39;analysis_parameters&#39;][&#39;preprocessing&#39;][&#39;filtering_laplacian_kernel&#39;] = (0.2,0.5,0.5)</span>
                    <span class="c1"># round_data[&#39;analysis_parameters&#39;][&#39;preprocessing&#39;][&#39;large_obj_removal_percentile&#39;] = 99</span>
                    <span class="c1"># round_data[&#39;analysis_parameters&#39;][&#39;preprocessing&#39;][&#39;large_obj_removal_min_obj_size&#39;]= 50</span>
                    <span class="c1"># round_data[&#39;analysis_parameters&#39;][&#39;preprocessing&#39;][&#39;large_obj_removal_selem&#39;] = 3</span>
                    <span class="n">round_data</span><span class="p">[</span><span class="s1">&#39;analysis_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;counting&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">round_data</span><span class="p">[</span><span class="s1">&#39;analysis_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;counting&#39;</span><span class="p">][</span><span class="s1">&#39;min_distance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
                    <span class="n">round_data</span><span class="p">[</span><span class="s1">&#39;analysis_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;counting&#39;</span><span class="p">][</span><span class="s1">&#39;min_obj_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
                    <span class="n">round_data</span><span class="p">[</span><span class="s1">&#39;analysis_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;counting&#39;</span><span class="p">][</span><span class="s1">&#39;max_obj_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">200</span>
                    <span class="n">round_data</span><span class="p">[</span><span class="s1">&#39;analysis_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;beads_registration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_fpath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">new_config</span><span class="p">:</span>
                    <span class="n">yaml</span><span class="o">.</span><span class="n">safe_dump</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">img_config_dict</span><span class="p">),</span> <span class="n">new_config</span><span class="p">,</span><span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>



<span class="k">def</span> <span class="nf">create_stringency_selection_fov_yaml</span><span class="p">(</span><span class="n">pipeline_config_fpath</span><span class="p">):</span>
    
    <span class="n">pipeline_config_dict</span> <span class="o">=</span> <span class="n">load_pipeline_config_file</span><span class="p">(</span><span class="n">pipeline_config_fpath</span><span class="p">)</span>
    <span class="n">fovs</span> <span class="o">=</span> <span class="p">(</span><span class="n">pipeline_config_dict</span><span class="p">[</span><span class="s1">&#39;channel_coords_dict&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">stringency</span> <span class="o">=</span> <span class="n">pipeline_config_dict</span><span class="p">[</span><span class="s1">&#39;pipeline_required_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;counting_settings&#39;</span><span class="p">][</span><span class="s1">&#39;stringency&#39;</span><span class="p">]</span>
    <span class="n">pipeline_config_dict</span><span class="p">[</span><span class="s1">&#39;pipeline_required_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;counting_settings&#39;</span><span class="p">][</span><span class="s1">&#39;stringency&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">pipeline_config_dict</span><span class="p">[</span><span class="s1">&#39;pipeline_required_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;counting_settings&#39;</span><span class="p">][</span><span class="s1">&#39;stringency&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="n">stringency</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">fovs</span><span class="p">}</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pipeline_config_fpath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">new_config</span><span class="p">:</span>
            <span class="n">yaml</span><span class="o">.</span><span class="n">safe_dump</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">pipeline_config_dict</span><span class="p">),</span> <span class="n">new_config</span><span class="p">,</span><span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">create_specific_fov_counting_thr_yaml</span><span class="p">(</span><span class="n">pipeline_config_fpath</span><span class="p">):</span>
    <span class="n">pipeline_config_dict</span> <span class="o">=</span> <span class="n">load_pipeline_config_file</span><span class="p">(</span><span class="n">pipeline_config_fpath</span><span class="p">)</span>
    <span class="n">fovs</span> <span class="o">=</span> <span class="p">(</span><span class="n">pipeline_config_dict</span><span class="p">[</span><span class="s1">&#39;channel_coords_dict&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">stringency</span> <span class="o">=</span> <span class="n">pipeline_config_dict</span><span class="p">[</span><span class="s1">&#39;pipeline_required_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;counting_settings&#39;</span><span class="p">][</span><span class="s1">&#39;thr_fov&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">pipeline_config_dict</span><span class="p">[</span><span class="s1">&#39;pipeline_required_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;counting_settings&#39;</span><span class="p">][</span><span class="s1">&#39;thr_fov&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="kc">None</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">fovs</span><span class="p">}</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pipeline_config_fpath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">new_config</span><span class="p">:</span>
            <span class="n">yaml</span><span class="o">.</span><span class="n">safe_dump</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">pipeline_config_dict</span><span class="p">),</span> <span class="n">new_config</span><span class="p">,</span><span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">select_dir</span><span class="p">(</span><span class="n">processing_directory</span><span class="p">,</span><span class="n">keyword</span><span class="p">):</span>
    <span class="n">list_hyb_fpaths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">processed_dirs</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">processing_directory</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">keyword</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">dir_name</span> <span class="ow">in</span> <span class="n">processed_dirs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">dir_name</span><span class="p">:</span>
                <span class="n">dir_path</span> <span class="o">=</span> <span class="n">processing_directory</span> <span class="o">/</span> <span class="n">dir_name</span>
                <span class="n">list_hyb_fpaths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">dir_name</span> <span class="ow">in</span> <span class="n">processed_dirs</span><span class="p">:</span>
            <span class="n">dir_path</span> <span class="o">=</span> <span class="n">processing_directory</span> <span class="o">/</span> <span class="n">dir_name</span>
            <span class="n">list_hyb_fpaths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">list_hyb_fpaths</span>



<span class="k">class</span> <span class="nc">OptionEatAll</span><span class="p">(</span><span class="n">click</span><span class="o">.</span><span class="n">Option</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    https://stackoverflow.com/questions/48391777/nargs-equivalent-for-options-in-click</span>

<span class="sd">    Option class to ingest undefined number of options.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_other_options</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;save_other_options&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">nargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;nargs&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">nargs</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;nargs, if set, must be -1 not </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nargs</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">OptionEatAll</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_previous_parser_process</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_eat_all_parser</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">add_to_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">parser_process</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
            <span class="c1"># method to hook to the parser.process</span>
            <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_other_options</span><span class="p">:</span>
                <span class="c1"># grab everything up to the next option</span>
                <span class="k">while</span> <span class="n">state</span><span class="o">.</span><span class="n">rargs</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eat_all_parser</span><span class="o">.</span><span class="n">prefixes</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">rargs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
                            <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
                        <span class="n">value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">rargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># grab everything remaining</span>
                <span class="n">value</span> <span class="o">+=</span> <span class="n">state</span><span class="o">.</span><span class="n">rargs</span>
                <span class="n">state</span><span class="o">.</span><span class="n">rargs</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="c1"># call the actual process</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_previous_parser_process</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>

        <span class="n">retval</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">OptionEatAll</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">add_to_parser</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">:</span>
            <span class="n">our_parser</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">_long_opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">or</span> <span class="n">parser</span><span class="o">.</span><span class="n">_short_opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">our_parser</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_eat_all_parser</span> <span class="o">=</span> <span class="n">our_parser</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_previous_parser_process</span> <span class="o">=</span> <span class="n">our_parser</span><span class="o">.</span><span class="n">process</span>
                <span class="n">our_parser</span><span class="o">.</span><span class="n">process</span> <span class="o">=</span> <span class="n">parser_process</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">retval</span>
</pre></div>

        </details>

            </section>
                <section id="free_space">
                            <div class="attr function"><a class="headerlink" href="#free_space">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">free_space</span><span class="signature">(hd_path: str, min_free_space: int)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">free_space</span><span class="p">(</span><span class="n">hd_path</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">min_free_space</span><span class="p">:</span><span class="nb">int</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function used to determine if there is enough space in the</span>
<span class="sd">    HD where the experiment will be processed</span>

<span class="sd">    Args:</span>
<span class="sd">    -----</span>
<span class="sd">        hd_path:str</span>
<span class="sd">            pathway of the target HD where the processing will be run</span>
<span class="sd">        min_free_space:int</span>
<span class="sd">            minimum space required for processing in Gb (ex: 1000)</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">        True/False: bool</span>
<span class="sd">            True if there is enough free space for running the experiment</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">selected_logger</span><span class="p">()</span>
    <span class="n">total</span><span class="p">,</span> <span class="n">used</span><span class="p">,</span> <span class="n">free</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">disk_usage</span><span class="p">(</span><span class="n">hd_path</span><span class="p">)</span>
    <span class="n">free_space_giga</span> <span class="o">=</span> <span class="n">free</span> <span class="o">//</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">30</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">free_space_giga</span> <span class="o">&lt;=</span> <span class="n">min_free_space</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Free space in the HD: </span><span class="si">{</span><span class="n">free_space_giga</span><span class="si">}</span><span class="s1"> Gb data cannot be transferred,</span><span class="se">\</span>
<span class="s1">                        not enough space on the HD&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Free space in the HD: </span><span class="si">{</span><span class="n">free_space_giga</span><span class="si">}</span><span class="s1"> Gb data can be transferred&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
</pre></div>

        </details>

            <div class="docstring"><p>Function used to determine if there is enough space in the
HD where the experiment will be processed</p>

<h2 id="args">Args:</h2>

<pre><code>hd_path:str
    pathway of the target HD where the processing will be run
min_free_space:int
    minimum space required for processing in Gb (ex: 1000)
</code></pre>

<h2 id="returns">Returns:</h2>

<pre><code>True/False: bool
    True if there is enough free space for running the experiment
</code></pre>
</div>


                </section>
                <section id="create_folder_structure">
                            <div class="attr function"><a class="headerlink" href="#create_folder_structure">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">create_folder_structure</span><span class="signature">(experiment_fpath: str, run_type: str)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">create_folder_structure</span><span class="p">(</span><span class="n">experiment_fpath</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="n">run_type</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class used to create the folder structure where to sort the files</span>
<span class="sd">    generated by the machines and the saving the data created during the</span>
<span class="sd">    processing. It creates the backbone structure common to all analysis</span>

<span class="sd">    FOLDER STRUCTURE</span>
<span class="sd">    - original_robofish_logs: contains all the original robofish logs.</span>
<span class="sd">    - extra_files: contains the extra files acquired during imaging.</span>
<span class="sd">    - extra_processing_data: contains extra files used in the analysis </span>
<span class="sd">                                                like the dark images for flat field correction.</span>
<span class="sd">    - pipeline_config: contains all the configuration files.</span>
<span class="sd">    - raw_data: contains the renamed .nd2 files and the corresponding </span>
<span class="sd">                        pickle configuration files. It is the directory that is </span>
<span class="sd">                        backed up on the server.</span>
<span class="sd">    - output_figures: contains the reports and visualizations</span>
<span class="sd">    - notebooks: will contain potential notebooks used for processing the data</span>
<span class="sd">    - probes: will contains the fasta file with the probes used in the experiment</span>
<span class="sd">    - tmp: save temporary data</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        experiment_fpath: str</span>
<span class="sd">            folder path of the experiment</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">selected_logger</span><span class="p">()</span>
    <span class="n">experiment_fpath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">experiment_fpath</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">run_type</span> <span class="o">==</span> <span class="s1">&#39;new&#39;</span><span class="p">:</span>

        <span class="n">folders_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;raw_data&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;original_robofish_logs&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;extra_processing_data&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;extra_files&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;pipeline_config&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;output_figures&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;notebooks&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;probes&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;tmp&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;logs&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;results&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;microscope_tiles_coords&#39;</span><span class="p">]</span>
        <span class="n">subfolders_tmp</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;raw_counts&#39;</span><span class="p">,</span><span class="s1">&#39;filtered_images&#39;</span><span class="p">,</span><span class="s1">&#39;registered_counts&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;combined_rounds_images&#39;</span><span class="p">]</span>
    
    <span class="k">else</span><span class="p">:</span>
        <span class="n">folders_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;extra_processing_data&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;pipeline_config&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;output_figures&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;probes&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;tmp&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;logs&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;results&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;microscope_tiles_coords&#39;</span><span class="p">]</span>
        <span class="n">subfolders_tmp</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;raw_counts&#39;</span><span class="p">,</span><span class="s1">&#39;filtered_images&#39;</span><span class="p">,</span><span class="s1">&#39;registered_counts&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;combined_rounds_images&#39;</span><span class="p">]</span>
    
    <span class="k">for</span> <span class="n">folder_name</span> <span class="ow">in</span> <span class="n">folders_list</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">experiment_fpath</span> <span class="o">/</span> <span class="n">folder_name</span> <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">folder_name</span><span class="si">}</span><span class="s1"> already exist&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">experiment_fpath</span> <span class="o">/</span> <span class="n">folder_name</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">experiment_fpath</span> <span class="o">/</span> <span class="n">folder_name</span><span class="p">,</span><span class="mo">0o777</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">folder_name</span> <span class="ow">in</span> <span class="n">subfolders_tmp</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;tmp&#39;</span> <span class="o">/</span> <span class="n">folder_name</span> <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">folder_name</span><span class="si">}</span><span class="s1"> already exist&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;tmp&#39;</span> <span class="o">/</span> <span class="n">folder_name</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;tmp&#39;</span> <span class="o">/</span> <span class="n">folder_name</span><span class="p">,</span><span class="mo">0o777</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Class used to create the folder structure where to sort the files
generated by the machines and the saving the data created during the
processing. It creates the backbone structure common to all analysis</p>

<p>FOLDER STRUCTURE</p>

<ul>
<li>original_robofish_logs: contains all the original robofish logs.</li>
<li>extra_files: contains the extra files acquired during imaging.</li>
<li>extra_processing_data: contains extra files used in the analysis 
                                        like the dark images for flat field correction.</li>
<li>pipeline_config: contains all the configuration files.</li>
<li>raw_data: contains the renamed .nd2 files and the corresponding 
                pickle configuration files. It is the directory that is 
                backed up on the server.</li>
<li>output_figures: contains the reports and visualizations</li>
<li>notebooks: will contain potential notebooks used for processing the data</li>
<li>probes: will contains the fasta file with the probes used in the experiment</li>
<li>tmp: save temporary data</li>
</ul>

<p>Args:
    experiment_fpath: str
        folder path of the experiment</p>
</div>


                </section>
                <section id="collect_processing_files">
                            <div class="attr function"><a class="headerlink" href="#collect_processing_files">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">collect_processing_files</span><span class="signature">(experiment_fpath: str, experiment_info: Dict)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">collect_processing_files</span><span class="p">(</span><span class="n">experiment_fpath</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">experiment_info</span><span class="p">:</span><span class="n">Dict</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Task used to sort the files in the experiment folder and</span>
<span class="sd">    gather the extra files required for the processing</span>
<span class="sd">    </span>
<span class="sd">    - instrument_name_dark_img for field correction</span>
<span class="sd">    - codebook if the experiment is barcoded</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">selected_logger</span><span class="p">()</span>

    <span class="n">experiment_fpath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">experiment_fpath</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">machine</span> <span class="o">=</span> <span class="n">experiment_info</span><span class="p">[</span><span class="s1">&#39;Machine&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
        <span class="n">machine</span> <span class="o">=</span> <span class="s1">&#39;NOT_DEFINED&#39;</span>

    <span class="c1"># This step can be also be removed in case we won&#39;t use the processing env config </span>
    <span class="n">processing_env_config_fpath</span> <span class="o">=</span> <span class="n">experiment_fpath</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s1">&#39;config_db&#39;</span> <span class="o">/</span> <span class="s1">&#39;processing_env_config.yaml&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">processing_env_config_fpath</span><span class="p">,</span> <span class="p">(</span><span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;pipeline_config&#39;</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;missing pipeline env config file&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;missing pipeline env config file&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># This step will be modified when the rpobes will be stored in shoji</span>
        <span class="n">probes_fpath</span> <span class="o">=</span> <span class="n">experiment_fpath</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s1">&#39;probes_sets&#39;</span> <span class="o">/</span> <span class="p">(</span><span class="n">experiment_info</span><span class="p">[</span><span class="s1">&#39;Probe_FASTA_name&#39;</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">probes_fpath</span><span class="p">,</span> <span class="p">(</span><span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;probes&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;missing probes set file&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;missing probes set file&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># This step will be modified when the codebook will be stored in shoji</span>
            <span class="k">if</span> <span class="s1">&#39;barcoded&#39;</span> <span class="ow">in</span> <span class="n">experiment_info</span><span class="p">[</span><span class="s1">&#39;Experiment_type&#39;</span><span class="p">]:</span>
                <span class="n">codebooks_folder</span> <span class="o">=</span> <span class="n">experiment_fpath</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s1">&#39;codebooks&#39;</span>
                <span class="n">codebook_code</span> <span class="o">=</span> <span class="n">experiment_info</span><span class="p">[</span><span class="s1">&#39;Codebook&#39;</span><span class="p">]</span>
                
                <span class="n">codebook_fpath</span> <span class="o">=</span> <span class="n">codebooks_folder</span> <span class="o">/</span> <span class="n">codebook_code</span>
                
                <span class="c1"># Create codebook folder in the experiment folder</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;codebook&#39;</span> <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;codebook folder already exist&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;codebook&#39;</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;codebook&#39;</span><span class="p">,</span><span class="mo">0o777</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">codebook_fpath</span><span class="p">,</span> <span class="p">(</span><span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;codebook&#39;</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;codebook is missing&#39;</span><span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;codebook is missing&#39;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Task used to sort the files in the experiment folder and
gather the extra files required for the processing</p>

<ul>
<li>instrument_name_dark_img for field correction</li>
<li>codebook if the experiment is barcoded</li>
</ul>
</div>


                </section>
                <section id="sort_data_into_folders">
                            <div class="attr function"><a class="headerlink" href="#sort_data_into_folders">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">sort_data_into_folders</span><span class="signature">(experiment_fpath: str, experiment_info: Dict)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">sort_data_into_folders</span><span class="p">(</span><span class="n">experiment_fpath</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="n">experiment_info</span><span class="p">:</span><span class="n">Dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function used to sort the files created by the machine and contained </span>
<span class="sd">    in the experiment folder in the subfolders</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        experiment_fpath: str</span>
<span class="sd">            location of the folder to be processed</span>
<span class="sd">        experiment_info: ordered dict</span>
<span class="sd">            ordered dict with the parsed info generated by the instrument</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">logger</span> <span class="o">=</span> <span class="n">selected_logger</span><span class="p">()</span>
    <span class="n">experiment_fpath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">experiment_fpath</span><span class="p">)</span>

    <span class="c1"># Move the robofish generated logs</span>
    <span class="n">robofish_logs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">experiment_fpath</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*.log&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">robofish_logs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">log</span> <span class="ow">in</span> <span class="n">robofish_logs</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">log</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span> <span class="p">(</span><span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;original_robofish_logs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;moved </span><span class="si">{</span><span class="n">log</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s1"> into original_robofish_logs&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;there are no original robofish logs in the experiment folder&#39;</span><span class="p">)</span>


    <span class="c1"># Move the crosses images</span>
    <span class="n">crosses_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">experiment_fpath</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*_cross.nd2&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">crosses_files</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">cross</span> <span class="ow">in</span> <span class="n">crosses_files</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">cross</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span> <span class="p">(</span><span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;extra_files&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;moved </span><span class="si">{</span><span class="n">cross</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s1"> into extra_files&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;there are no crosses images in the experiment folders&#39;</span><span class="p">)</span>
    
    <span class="c1"># Move the coords files</span>
    <span class="n">coords_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">experiment_fpath</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*.xml&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords_files</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">coords_files</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">coord</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span> <span class="p">(</span><span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;extra_files&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;moved </span><span class="si">{</span><span class="n">coord</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s1"> into extra_files&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;there are no coords files in the experiment folders&#39;</span><span class="p">)</span>
    
    <span class="c1"># Move the fresh nuclei file for eel</span>
    <span class="k">if</span> <span class="s1">&#39;eel&#39;</span> <span class="ow">in</span> <span class="n">experiment_info</span><span class="p">[</span><span class="s1">&#39;Experiment_type&#39;</span><span class="p">]:</span>
        <span class="n">nuclei_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">experiment_fpath</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*ChannelEuropium_Cy3*&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nuclei_files</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;fresh_nuclei&#39;</span> <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;fresh_nuclei already exist&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;fresh_nuclei&#39;</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;fresh_nuclei&#39;</span><span class="p">,</span><span class="mo">0o777</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">nuclei</span> <span class="ow">in</span> <span class="n">nuclei_files</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">nuclei</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span> <span class="p">(</span><span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;fresh_nuclei&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;moved </span><span class="si">{</span><span class="n">nuclei</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s1"> into fresh nuclei&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The experiment does not have images of fresh nuclei&#39;</span><span class="p">)</span>
        
        <span class="n">large_views</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">experiment_fpath</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*ChannelDAPI*&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">large_views</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">large_view</span> <span class="ow">in</span> <span class="n">large_views</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">large_view</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span> <span class="p">(</span><span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;extra_files&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;moved </span><span class="si">{</span><span class="n">large_view</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s1"> into extra_files&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The experiment does not have large view images of fresh nuclei&#39;</span><span class="p">)</span>

    <span class="c1"># move remaining .nd2 files</span>
    <span class="n">all_nd2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">experiment_fpath</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*.nd2&#39;</span><span class="p">))</span>
    <span class="n">remaining</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">all_nd2</span> <span class="k">if</span> <span class="s1">&#39;Count&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">el</span><span class="o">.</span><span class="n">stem</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">remaining</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">fremaining</span> <span class="ow">in</span> <span class="n">remaining</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">fremaining</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span> <span class="p">(</span><span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;extra_files&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;moved </span><span class="si">{</span><span class="n">fremaining</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s1"> into extra_files&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;There are no extra files to be moved&#39;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Function used to sort the files created by the machine and contained 
in the experiment folder in the subfolders</p>

<p>Args:
    experiment_fpath: str
        location of the folder to be processed
    experiment_info: ordered dict
        ordered dict with the parsed info generated by the instrument</p>
</div>


                </section>
                <section id="create_dark_img">
                            <div class="attr function"><a class="headerlink" href="#create_dark_img">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">create_dark_img</span><span class="signature">(experiment_fpath, experiment_info)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">create_dark_img</span><span class="p">(</span><span class="n">experiment_fpath</span><span class="p">,</span><span class="n">experiment_info</span><span class="p">):</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">selected_logger</span><span class="p">()</span>
    <span class="n">experiment_fpath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">experiment_fpath</span><span class="p">)</span>
    <span class="n">experiment_name</span> <span class="o">=</span> <span class="n">experiment_info</span><span class="p">[</span><span class="s1">&#39;EXP_name&#39;</span><span class="p">]</span>
    <span class="n">machine</span> <span class="o">=</span> <span class="n">experiment_info</span><span class="p">[</span><span class="s1">&#39;Machine&#39;</span><span class="p">]</span>
    <span class="c1"># Check if the dark image is already present</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">pres</span> <span class="o">=</span> <span class="nb">list</span><span class="p">((</span><span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;extra_processing_data&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*_dark_img.npy&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">nd2_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">((</span><span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;extra_files&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*.nd2&#39;</span><span class="p">))</span>
        <span class="n">nd2_blank</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">nd2_list</span> <span class="k">if</span> <span class="s1">&#39;Blank&#39;</span> <span class="ow">in</span> <span class="n">el</span><span class="o">.</span><span class="n">stem</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">nd2_blank</span><span class="p">:</span>
            <span class="n">nd2fh</span> <span class="o">=</span> <span class="n">nd2reader</span><span class="o">.</span><span class="n">ND2Reader</span><span class="p">(</span><span class="n">nd2_blank</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">nd2fh</span><span class="o">.</span><span class="n">bundle_axes</span> <span class="o">=</span> <span class="s1">&#39;zyx&#39;</span>
            <span class="n">nd2fh</span><span class="o">.</span><span class="n">iter_axes</span> <span class="o">=</span> <span class="s1">&#39;z&#39;</span>
            <span class="c1"># Image with single channel</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="n">nd2fh</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># I can collect just one z because error of the reader</span>
            <span class="c1"># that created both z and t planes</span>
            <span class="n">dark_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">nd2fh</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">dark_img</span> <span class="o">=</span> <span class="n">dark_img</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;extra_processing_data&#39;</span> <span class="o">/</span> <span class="p">(</span><span class="n">experiment_name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">machine</span> <span class="o">+</span> <span class="s1">&#39;_dark_img.npy&#39;</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">dark_img</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Created dark image&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;the Blank .nd2 for the dark image is missing&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;the dark image is already present&#39;</span><span class="p">)</span>
</pre></div>

        </details>

    

                </section>
                <section id="sorting_grps">
                            <div class="attr function"><a class="headerlink" href="#sorting_grps">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">sorting_grps</span><span class="signature">(grps, experiment_info, analysis_parameters)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">sorting_grps</span><span class="p">(</span><span class="n">grps</span><span class="p">,</span> <span class="n">experiment_info</span><span class="p">,</span> <span class="n">analysis_parameters</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function used to separate the group names according to </span>
<span class="sd">    the processing type</span>
<span class="sd">    Args:</span>
<span class="sd">    -----</span>
<span class="sd">        grps = zarr.hierarchy.Group</span>
<span class="sd">            consolidate hierarchy zarr groups for fast access to metadata</span>
<span class="sd">        experiment_info: ordered dict</span>
<span class="sd">            ordered dict with the parsed info generated by the instrument</span>
<span class="sd">        analysis_parameters: dict</span>
<span class="sd">            dict with all the parameters to use for analysis  </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">        fish_grp: list</span>
<span class="sd">            list of the groups containing fish images</span>
<span class="sd">        fish_selected_parameters: list</span>
<span class="sd">            matching parameters used for fish analysis</span>
<span class="sd">        beads_grp: list</span>
<span class="sd">            list of the groups containing beads images</span>
<span class="sd">        beads_selected_parameters: list</span>
<span class="sd">            matching parameters used for beads analysis</span>
<span class="sd">        staining_grp: list</span>
<span class="sd">            list of the groups containing IF/staining images</span>
<span class="sd">        staining_selected_parameters:list</span>
<span class="sd">            matching parameters used for IF/staining analysis</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">fish_grp</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">beads_grp</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">staining_grp</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">grps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">grp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;stitching_channel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">grp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">]:</span>
            <span class="n">beads_grp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;_ST&#39;</span> <span class="ow">in</span> <span class="n">grp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;target_name&#39;</span><span class="p">]:</span>
            <span class="n">staining_grp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fish_grp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">experiment_info</span><span class="p">[</span><span class="s1">&#39;Stitching_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;small-beads&#39;</span><span class="p">:</span>
        <span class="n">beads_selected_parameters</span>  <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;small-beads&#39;</span><span class="p">]</span>
        <span class="n">beads_selected_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">experiment_info</span><span class="p">[</span><span class="s1">&#39;Stitching_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;large-beads&#39;</span><span class="p">:</span>
        <span class="n">beads_selected_parameters</span>  <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;large-beads&#39;</span><span class="p">]</span>
        <span class="n">beads_selected_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">experiment_info</span><span class="p">[</span><span class="s1">&#39;Stitching_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;both-beads&#39;</span><span class="p">:</span>
        <span class="n">beads_selected_parameters</span>  <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;both-beads&#39;</span><span class="p">]</span>
        <span class="n">beads_selected_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">experiment_info</span><span class="p">[</span><span class="s1">&#39;Stitching_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;nuclei&#39;</span> <span class="p">:</span>
        <span class="n">beads_selected_parameters</span>  <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;nuclei&#39;</span><span class="p">]</span>
        <span class="n">beads_selected_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Wrong stitching type in the experiment file&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Wrong stitching type in the experiment file&#39;</span><span class="p">)</span>
    
    <span class="n">fish_selected_parameters</span> <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;fish&#39;</span><span class="p">]</span>
    <span class="n">fish_selected_parameters</span><span class="p">[</span><span class="s1">&#39;BarcodesExtractionResolution&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;BarcodesExtractionResolution&#39;</span><span class="p">]</span>
    <span class="n">fish_selected_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span>

    <span class="n">staining_selected_parameters</span> <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;staining&#39;</span><span class="p">]</span>
    <span class="n">staining_selected_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span>

    <span class="n">combined_grps</span> <span class="o">=</span><span class="p">{</span><span class="s1">&#39;fish&#39;</span><span class="p">:(</span><span class="n">fish_grp</span><span class="p">,</span> <span class="n">fish_selected_parameters</span><span class="p">),</span>
                    <span class="s1">&#39;beads&#39;</span><span class="p">:(</span><span class="n">beads_grp</span><span class="p">,</span> <span class="n">beads_selected_parameters</span><span class="p">),</span>
                    <span class="s1">&#39;staining&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">staining_grp</span><span class="p">,</span> <span class="n">staining_selected_parameters</span><span class="p">)</span>
                    <span class="p">}</span>

    <span class="k">return</span> <span class="n">combined_grps</span>
</pre></div>

        </details>

            <div class="docstring"><p>Function used to separate the group names according to 
the processing type</p>

<h2 id="args">Args:</h2>

<pre><code>grps = zarr.hierarchy.Group
    consolidate hierarchy zarr groups for fast access to metadata
experiment_info: ordered dict
    ordered dict with the parsed info generated by the instrument
analysis_parameters: dict
    dict with all the parameters to use for analysis
</code></pre>

<h2 id="returns">Returns:</h2>

<pre><code>fish_grp: list
    list of the groups containing fish images
fish_selected_parameters: list
    matching parameters used for fish analysis
beads_grp: list
    list of the groups containing beads images
beads_selected_parameters: list
    matching parameters used for beads analysis
staining_grp: list
    list of the groups containing IF/staining images
staining_selected_parameters:list
    matching parameters used for IF/staining analysis
</code></pre>
</div>


                </section>
                <section id="sorting_grps_for_fov_processing">
                            <div class="attr function"><a class="headerlink" href="#sorting_grps_for_fov_processing">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">sorting_grps_for_fov_processing</span><span class="signature">(consolidated_grp, experiment_info, analysis_parameters)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">sorting_grps_for_fov_processing</span><span class="p">(</span><span class="n">consolidated_grp</span><span class="p">,</span> <span class="n">experiment_info</span><span class="p">,</span> <span class="n">analysis_parameters</span><span class="p">):</span>

    <span class="n">registration_channel</span> <span class="o">=</span> <span class="n">experiment_info</span><span class="p">[</span><span class="s1">&#39;StitchingChannel&#39;</span><span class="p">]</span>
    <span class="n">experiment_name</span> <span class="o">=</span>  <span class="n">experiment_info</span><span class="p">[</span><span class="s1">&#39;EXP_name&#39;</span><span class="p">]</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">experiment_name</span> <span class="o">+</span> <span class="s1">&#39;_Hybridization01_&#39;</span> <span class="o">+</span> <span class="n">registration_channel</span> <span class="o">+</span> <span class="s1">&#39;_fov_0&#39;</span>
    <span class="n">fovs</span> <span class="o">=</span> <span class="n">consolidated_grp</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;fields_of_view&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">experiment_info</span><span class="p">[</span><span class="s1">&#39;Stitching_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;small-beads&#39;</span><span class="p">:</span>
            <span class="n">registration_selected_parameters</span>  <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;small-beads&#39;</span><span class="p">]</span>
            <span class="n">registration_selected_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">experiment_info</span><span class="p">[</span><span class="s1">&#39;Stitching_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;large-beads&#39;</span><span class="p">:</span>
        <span class="n">registration_selected_parameters</span>  <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;large-beads&#39;</span><span class="p">]</span>
        <span class="n">registration_selected_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">experiment_info</span><span class="p">[</span><span class="s1">&#39;Stitching_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;both-beads&#39;</span><span class="p">:</span>
        <span class="n">registration_selected_parameters</span>  <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;both-beads&#39;</span><span class="p">]</span>
        <span class="n">registration_selected_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">experiment_info</span><span class="p">[</span><span class="s1">&#39;Stitching_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;nuclei&#39;</span> <span class="p">:</span>
        <span class="n">registration_selected_parameters</span>  <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;nuclei&#39;</span><span class="p">]</span>
        <span class="n">registration_selected_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Wrong stitching type in the experiment file&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Wrong stitching type in the experiment file&#39;</span><span class="p">)</span>

    <span class="n">fish_selected_parameters</span> <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;fish&#39;</span><span class="p">]</span>
    <span class="n">fish_selected_parameters</span><span class="p">[</span><span class="s1">&#39;BarcodesExtractionResolution&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;BarcodesExtractionResolution&#39;</span><span class="p">]</span>
    <span class="n">fish_selected_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span>

    <span class="n">staining_selected_parameters</span> <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;staining&#39;</span><span class="p">]</span>
    <span class="n">staining_selected_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis_parameters</span><span class="p">[</span><span class="s1">&#39;RegistrationReferenceHybridization&#39;</span><span class="p">]</span>


    <span class="c1"># Group the names by fov</span>
    <span class="n">grpd_by_fov</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">fov</span> <span class="ow">in</span> <span class="n">fovs</span><span class="p">:</span>
        <span class="n">grpd_by_fov</span><span class="p">[</span><span class="n">fov</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">grpd_by_fov</span><span class="p">[</span><span class="n">fov</span><span class="p">][</span><span class="s1">&#39;split&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">grpd_by_fov</span><span class="p">[</span><span class="n">fov</span><span class="p">][</span><span class="s1">&#39;all_names&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">consolidated_grp</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">fov</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_fov_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">grpd_by_fov</span><span class="p">[</span><span class="n">fov</span><span class="p">][</span><span class="s1">&#39;all_names&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>


    <span class="c1"># Regroup by processing type</span>
    <span class="k">for</span> <span class="n">fov</span><span class="p">,</span> <span class="n">data_dict</span> <span class="ow">in</span> <span class="n">grpd_by_fov</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">grpd_by_fov</span><span class="p">[</span><span class="n">fov</span><span class="p">][</span><span class="s1">&#39;split&#39;</span><span class="p">][</span><span class="s1">&#39;fish&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">grpd_by_fov</span><span class="p">[</span><span class="n">fov</span><span class="p">][</span><span class="s1">&#39;split&#39;</span><span class="p">][</span><span class="s1">&#39;registration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">grpd_by_fov</span><span class="p">[</span><span class="n">fov</span><span class="p">][</span><span class="s1">&#39;split&#39;</span><span class="p">][</span><span class="s1">&#39;staining&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;all_names&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">consolidated_grp</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;stitching_channel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">consolidated_grp</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">consolidated_grp</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">grpd_by_fov</span><span class="p">[</span><span class="n">fov</span><span class="p">][</span><span class="s1">&#39;split&#39;</span><span class="p">][</span><span class="s1">&#39;registration&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">grpd_by_fov</span><span class="p">[</span><span class="n">fov</span><span class="p">][</span><span class="s1">&#39;split&#39;</span><span class="p">][</span><span class="s1">&#39;registration&#39;</span><span class="p">][</span><span class="n">consolidated_grp</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">grpd_by_fov</span><span class="p">[</span><span class="n">fov</span><span class="p">][</span><span class="s1">&#39;split&#39;</span><span class="p">][</span><span class="s1">&#39;registration&#39;</span><span class="p">][</span><span class="n">consolidated_grp</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">([],</span><span class="n">registration_selected_parameters</span><span class="p">)</span>
                    <span class="n">grpd_by_fov</span><span class="p">[</span><span class="n">fov</span><span class="p">][</span><span class="s1">&#39;split&#39;</span><span class="p">][</span><span class="s1">&#39;registration&#39;</span><span class="p">][</span><span class="n">consolidated_grp</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;_ST&#39;</span> <span class="ow">in</span> <span class="n">consolidated_grp</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;target_name&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">consolidated_grp</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">grpd_by_fov</span><span class="p">[</span><span class="n">fov</span><span class="p">][</span><span class="s1">&#39;split&#39;</span><span class="p">][</span><span class="s1">&#39;staining&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">grpd_by_fov</span><span class="p">[</span><span class="n">fov</span><span class="p">][</span><span class="s1">&#39;split&#39;</span><span class="p">][</span><span class="s1">&#39;staining&#39;</span><span class="p">][</span><span class="n">consolidated_grp</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">grpd_by_fov</span><span class="p">[</span><span class="n">fov</span><span class="p">][</span><span class="s1">&#39;split&#39;</span><span class="p">][</span><span class="s1">&#39;staining&#39;</span><span class="p">][</span><span class="n">consolidated_grp</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">([],</span><span class="n">staining_selected_parameters</span><span class="p">)</span>
                    <span class="n">grpd_by_fov</span><span class="p">[</span><span class="n">fov</span><span class="p">][</span><span class="s1">&#39;split&#39;</span><span class="p">][</span><span class="s1">&#39;staining&#39;</span><span class="p">][</span><span class="n">consolidated_grp</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">consolidated_grp</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">grpd_by_fov</span><span class="p">[</span><span class="n">fov</span><span class="p">][</span><span class="s1">&#39;split&#39;</span><span class="p">][</span><span class="s1">&#39;fish&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">grpd_by_fov</span><span class="p">[</span><span class="n">fov</span><span class="p">][</span><span class="s1">&#39;split&#39;</span><span class="p">][</span><span class="s1">&#39;fish&#39;</span><span class="p">][</span><span class="n">consolidated_grp</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">grpd_by_fov</span><span class="p">[</span><span class="n">fov</span><span class="p">][</span><span class="s1">&#39;split&#39;</span><span class="p">][</span><span class="s1">&#39;fish&#39;</span><span class="p">][</span><span class="n">consolidated_grp</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">([],</span><span class="n">fish_selected_parameters</span><span class="p">)</span>
                    <span class="n">grpd_by_fov</span><span class="p">[</span><span class="n">fov</span><span class="p">][</span><span class="s1">&#39;split&#39;</span><span class="p">][</span><span class="s1">&#39;fish&#39;</span><span class="p">][</span><span class="n">consolidated_grp</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">grpd_by_fov</span>
</pre></div>

        </details>

    

                </section>
                <section id="create_dir">
                            <div class="attr function"><a class="headerlink" href="#create_dir">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">create_dir</span><span class="signature">(dir_path)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">create_dir</span><span class="p">(</span><span class="n">dir_path</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span><span class="mo">0o777</span><span class="p">)</span>
</pre></div>

        </details>

    

                </section>
                <section id="register_images">
                            <div class="attr function"><a class="headerlink" href="#register_images">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">register_images</span><span class="signature">(img, shift)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">register_images</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">shift</span><span class="p">):</span>
        <span class="n">offset_image</span> <span class="o">=</span> <span class="n">fourier_shift</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftn</span><span class="p">(</span><span class="n">img</span><span class="p">),</span> <span class="n">shift</span><span class="p">)</span>
        <span class="n">offset_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftn</span><span class="p">(</span><span class="n">offset_image</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
        <span class="k">return</span> <span class="n">offset_image</span>
</pre></div>

        </details>

    

                </section>
                <section id="combine_rounds_images">
                            <div class="attr function"><a class="headerlink" href="#combine_rounds_images">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">combine_rounds_images</span><span class="signature">(
    images_path_list,
    experiment_fpath,
    experiment_info,
    all_rounds_shifts,
    save=True
)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">combine_rounds_images</span><span class="p">(</span><span class="n">images_path_list</span><span class="p">,</span><span class="n">experiment_fpath</span><span class="p">,</span> <span class="n">experiment_info</span><span class="p">,</span><span class="n">all_rounds_shifts</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">experiment_fpath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">experiment_fpath</span><span class="p">)</span>
    
    <span class="n">rounds_num</span> <span class="o">=</span> <span class="n">experiment_info</span><span class="p">[</span><span class="s1">&#39;Barcode_length&#39;</span><span class="p">]</span>
    <span class="n">fov</span> <span class="o">=</span> <span class="n">images_path_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stem</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">channel</span> <span class="o">=</span> <span class="n">images_path_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stem</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">experiment_name</span> <span class="o">=</span> <span class="n">experiment_info</span><span class="p">[</span><span class="s1">&#39;EXP_name&#39;</span><span class="p">]</span>

    <span class="n">fpath_dots</span> <span class="o">=</span> <span class="n">images_path_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="p">(</span><span class="n">fpath_dots</span><span class="o">.</span><span class="n">stem</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_dots&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_filtered.pkl&#39;</span>
    <span class="n">path_img</span> <span class="o">=</span> <span class="n">fpath_dots</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s1">&#39;filtered_images&#39;</span> <span class="o">/</span> <span class="n">fname</span>
    <span class="n">img</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">path_img</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">))</span>
    <span class="n">img_stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">rounds_num</span><span class="p">,</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>

    <span class="k">for</span> <span class="n">fpath_dots</span> <span class="ow">in</span> <span class="n">images_path_list</span><span class="p">:</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="p">(</span><span class="n">fpath_dots</span><span class="o">.</span><span class="n">stem</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_dots&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_filtered.pkl&#39;</span>
        <span class="n">path_img</span> <span class="o">=</span> <span class="n">fpath_dots</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s1">&#39;filtered_images&#39;</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="n">path_img</span> <span class="o">/</span> <span class="n">fname</span>
        <span class="n">round_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;Hybridization&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">img</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">))</span>
        <span class="n">img</span><span class="p">[</span><span class="n">img</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="n">all_rounds_shifts</span><span class="p">[</span><span class="n">round_num</span><span class="p">]</span>
        <span class="n">shifted_img</span> <span class="o">=</span> <span class="n">register_images</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">shift</span><span class="p">)</span>
        <span class="n">img_stack</span><span class="p">[</span><span class="n">round_num</span><span class="o">-</span><span class="mi">1</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">shifted_img</span>

    <span class="n">fpath</span> <span class="o">=</span> <span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;tmp&#39;</span> <span class="o">/</span> <span class="s1">&#39;combined_rounds_images&#39;</span> <span class="o">/</span> <span class="p">(</span><span class="n">experiment_name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">channel</span> <span class="o">+</span> <span class="s1">&#39;_combined_img_fov_&#39;</span> <span class="o">+</span> <span class="n">fov</span> <span class="o">+</span> <span class="s1">&#39;.npy&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
        <span class="c1"># Add conversion to more compress ftype</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">img_stack</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">img_stack</span>
</pre></div>

        </details>

    

                </section>
                <section id="combine_filtered_images">
                            <div class="attr function"><a class="headerlink" href="#combine_filtered_images">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">combine_filtered_images</span><span class="signature">(output_list, experiment_fpath, metadata, save=False)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">combine_filtered_images</span><span class="p">(</span><span class="n">output_list</span><span class="p">,</span><span class="n">experiment_fpath</span><span class="p">,</span><span class="n">metadata</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">experiment_fpath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">experiment_fpath</span><span class="p">)</span>
     
    <span class="n">img_stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;total_rounds&#39;</span><span class="p">],</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;img_width&#39;</span><span class="p">],</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;img_height&#39;</span><span class="p">]])</span>

    <span class="k">for</span> <span class="n">img</span><span class="p">,</span> <span class="n">img_meta</span> <span class="ow">in</span> <span class="n">output_list</span><span class="p">:</span>
        <span class="n">round_num</span> <span class="o">=</span> <span class="n">img_meta</span><span class="o">.</span><span class="n">round_num</span>
        <span class="n">img_stack</span><span class="p">[</span><span class="n">round_num</span><span class="o">-</span><span class="mi">1</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">img</span>

    <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
        <span class="c1"># Add conversion to more compress ftype</span>
        <span class="n">img_meta</span> <span class="o">=</span> <span class="n">output_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">channel</span> <span class="o">=</span> <span class="n">img_meta</span><span class="o">.</span><span class="n">channel</span>
        <span class="n">fov</span> <span class="o">=</span> <span class="n">img_meta</span><span class="o">.</span><span class="n">fov_num</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;tmp&#39;</span> <span class="o">/</span> <span class="s1">&#39;combined_rounds_images&#39;</span> <span class="o">/</span> <span class="p">(</span><span class="n">experiment_name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">channel</span> <span class="o">+</span> <span class="s1">&#39;_combined_img_fov_&#39;</span> <span class="o">+</span> <span class="n">fov</span> <span class="o">+</span> <span class="s1">&#39;.npy&#39;</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">img_stack</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">img_stack</span>
</pre></div>

        </details>

    

                </section>
                <section id="register_combined_rounds_images">
                            <div class="attr function"><a class="headerlink" href="#register_combined_rounds_images">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">register_combined_rounds_images</span><span class="signature">(combined_round_images, all_rounds_shifts)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">register_combined_rounds_images</span><span class="p">(</span><span class="n">combined_round_images</span><span class="p">,</span><span class="n">all_rounds_shifts</span><span class="p">):</span>
    
    <span class="n">img_stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">combined_round_images</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">round_num</span><span class="p">,</span> <span class="n">shift</span> <span class="ow">in</span> <span class="n">all_rounds_shifts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">combined_round_images</span><span class="p">[</span><span class="n">round_num</span><span class="o">-</span><span class="mi">1</span><span class="p">,:,:]</span>
        <span class="n">img</span><span class="p">[</span><span class="n">img</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">shifted_img</span> <span class="o">=</span> <span class="n">register_images</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">shift</span><span class="p">)</span>
        <span class="n">img_stack</span><span class="p">[</span><span class="n">round_num</span><span class="o">-</span><span class="mi">1</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">shifted_img</span>

    <span class="k">return</span> <span class="n">img_stack</span>
</pre></div>

        </details>

    

                </section>
                <section id="copytree">
                            <div class="attr function"><a class="headerlink" href="#copytree">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">copytree</span><span class="signature">(src, dst, symlinks=False, ignore=None)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">copytree</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">symlinks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="n">copytree</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">symlinks</span><span class="p">,</span> <span class="n">ignore</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span> <span class="o">-</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</pre></div>

        </details>

    

                </section>
                <section id="not_run_counting_sorted_grps">
                            <div class="attr function"><a class="headerlink" href="#not_run_counting_sorted_grps">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">not_run_counting_sorted_grps</span><span class="signature">(experiment_fpath, sorted_grps)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">not_run_counting_sorted_grps</span><span class="p">(</span><span class="n">experiment_fpath</span><span class="p">,</span> <span class="n">sorted_grps</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function to identify the files not processed for counting</span>
<span class="sd">    because a failure of dask/htcondor. Identify the files that</span>
<span class="sd">    remain to be processed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">experiment_fpath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">experiment_fpath</span><span class="p">)</span>
    <span class="n">counts_fpath</span> <span class="o">=</span> <span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;tmp&#39;</span> <span class="o">/</span> <span class="s1">&#39;raw_counts&#39;</span>
    
    <span class="n">non_processed_sorted_grps</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="n">files_processed</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">counts_fpath</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*_dots.pkl&#39;</span><span class="p">))</span>
    <span class="n">files_processed</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span><span class="o">.</span><span class="n">stem</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">files_processed</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="n">grp</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span> <span class="ow">in</span> <span class="n">sorted_grps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">non_processed_grp</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">zarr_grp_name</span> <span class="ow">in</span> <span class="n">grp</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">zarr_grp_name</span> <span class="ow">in</span> <span class="n">files_processed</span><span class="p">:</span>
                <span class="n">files_processed</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">zarr_grp_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">non_processed_grp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zarr_grp_name</span><span class="p">)</span>
        <span class="n">non_processed_sorted_grps</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">non_processed_grp</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">non_processed_sorted_grps</span>
</pre></div>

        </details>

            <div class="docstring"><p>Helper function to identify the files not processed for counting
because a failure of dask/htcondor. Identify the files that
remain to be processed.</p>
</div>


                </section>
                <section id="convert_to_uint16_full_float64_range">
                            <div class="attr function"><a class="headerlink" href="#convert_to_uint16_full_float64_range">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">convert_to_uint16_full_float64_range</span><span class="signature">(image)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">convert_to_uint16_full_float64_range</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
    <span class="c1"># Clip the values above 1</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">image</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">.</span><span class="n">max</span>
    <span class="c1"># image[image &gt; 1] = 1</span>
    <span class="c1"># in the current processing step the images are float</span>
    <span class="c1"># but not anymore between (0,1)</span>
    <span class="c1"># Scale to the max of the uint16</span>
    <span class="n">image</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span><span class="o">.</span><span class="n">max</span>
    <span class="c1"># Round and convert to integer</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">image</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">image</span>
</pre></div>

        </details>

    

                </section>
                <section id="convert_to_uint16">
                            <div class="attr function"><a class="headerlink" href="#convert_to_uint16">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">convert_to_uint16</span><span class="signature">(image)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">convert_to_uint16</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Consider that the original images were uint16</span>
<span class="sd">    that is why i normalize for np.iinfo(np.uint16).max*1.0</span>
<span class="sd">    otherwise the values will be to small</span>
<span class="sd">    &quot;&quot;&quot;</span>
 
    <span class="n">image</span> <span class="o">=</span> <span class="n">image</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="o">*</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span><span class="o">.</span><span class="n">max</span>
    <span class="c1"># Round and convert to integer</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">image</span>
</pre></div>

        </details>

            <div class="docstring"><p>Consider that the original images were uint16
that is why i normalize for np.iinfo(np.uint16).max*1.0
otherwise the values will be to small</p>
</div>


                </section>
                <section id="convert_from_uint16_to_float64">
                            <div class="attr function"><a class="headerlink" href="#convert_from_uint16_to_float64">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">convert_from_uint16_to_float64</span><span class="signature">(image)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">convert_from_uint16_to_float64</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">image</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span><span class="o">.</span><span class="n">max</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">img_as_float64</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">image</span>
</pre></div>

        </details>

    

                </section>
                <section id="load_pipeline_config_file">
                            <div class="attr function"><a class="headerlink" href="#load_pipeline_config_file">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">load_pipeline_config_file</span><span class="signature">(pipeline_config_fpath)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">load_pipeline_config_file</span><span class="p">(</span><span class="n">pipeline_config_fpath</span><span class="p">):</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">pipeline_config_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">pipeline_config_fpath</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">pipeline_config_dict</span>
    <span class="k">except</span> <span class="ne">FileExistsError</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pipeline_config_fpath</span><span class="si">}</span><span class="s1"> missing&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pipeline_config_fpath</span><span class="si">}</span><span class="s1"> missing&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pipeline_config_fpath</span><span class="si">}</span><span class="s1"> wrong pathway name&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pipeline_config_fpath</span><span class="si">}</span><span class="s1"> wrong pathway name&#39;</span><span class="p">)</span>
</pre></div>

        </details>

    

                </section>
                <section id="load_running_analysis_config_file">
                            <div class="attr function"><a class="headerlink" href="#load_running_analysis_config_file">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">load_running_analysis_config_file</span><span class="signature">(experiment_fpath)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">load_running_analysis_config_file</span><span class="p">(</span><span class="n">experiment_fpath</span><span class="p">):</span>
    <span class="n">experiment_fpath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">experiment_fpath</span><span class="p">)</span>
    <span class="n">config_fpath</span> <span class="o">=</span> <span class="n">experiment_fpath</span> <span class="o">/</span>  <span class="s1">&#39;pipeline_config&#39;</span>
    <span class="n">running_analysis_config_fpath</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">config_fpath</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*_analysis_run.yaml&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">running_analysis_config_fpath</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;missing running analysis config file&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;missing running analysis config file&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">running_analysis_config_fpath</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;too many running analysis config file&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;too many running analysis config file&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">running_analysis_config_fpath</span> <span class="o">=</span> <span class="n">running_analysis_config_fpath</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">running_analysis_config</span> <span class="o">=</span> <span class="n">load_pipeline_config_file</span><span class="p">(</span><span class="n">running_analysis_config_fpath</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">running_analysis_config</span>
</pre></div>

        </details>

    

                </section>
                <section id="modify_images_config">
                            <div class="attr function"><a class="headerlink" href="#modify_images_config">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">modify_images_config</span><span class="signature">(experiment_fpath: str, keyword: str)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">modify_images_config</span><span class="p">(</span><span class="n">experiment_fpath</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="n">keyword</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function used to batch modify the values of the</span>
<span class="sd">    processing parameters in the images_config.yaml</span>
<span class="sd">    files</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    experiment_fpath: str</span>
<span class="sd">        path of the experiment to process</span>
<span class="sd">    keyword: str</span>
<span class="sd">        selection criteria used to process a subset of</span>
<span class="sd">        configuration files</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">experiment_fpath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">experiment_fpath</span><span class="p">)</span>
    <span class="n">pipeline_config_dpath</span> <span class="o">=</span> <span class="n">experiment_fpath</span> <span class="o">/</span> <span class="s1">&#39;pipeline_config&#39;</span>

    <span class="k">for</span> <span class="n">config_fpath</span> <span class="ow">in</span> <span class="n">pipeline_config_dpath</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*_images_config.yaml&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">config_fpath</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="n">img_config_dict</span> <span class="o">=</span> <span class="n">load_pipeline_config_file</span><span class="p">(</span><span class="n">config_fpath</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">fov_name</span><span class="p">,</span> <span class="n">fov_data</span> <span class="ow">in</span> <span class="n">img_config_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">round_name</span><span class="p">,</span> <span class="n">round_data</span> <span class="ow">in</span> <span class="n">fov_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="c1"># round_data[&#39;analysis_parameters&#39;] = {}</span>
                    <span class="c1"># round_data[&#39;analysis_parameters&#39;][&#39;preprocessing&#39;] = {}</span>
                    <span class="c1"># round_data[&#39;analysis_parameters&#39;][&#39;preprocessing&#39;][&#39;flat_field_kernel&#39;] = (2,100,100)</span>
                    <span class="c1"># round_data[&#39;analysis_parameters&#39;][&#39;preprocessing&#39;][&#39;filtering_small_kernel&#39;] = (1,8,8)</span>
                    <span class="c1"># round_data[&#39;analysis_parameters&#39;][&#39;preprocessing&#39;][&#39;filtering_laplacian_kernel&#39;] = (0.2,0.5,0.5)</span>
                    <span class="c1"># round_data[&#39;analysis_parameters&#39;][&#39;preprocessing&#39;][&#39;large_obj_removal_percentile&#39;] = 99</span>
                    <span class="c1"># round_data[&#39;analysis_parameters&#39;][&#39;preprocessing&#39;][&#39;large_obj_removal_min_obj_size&#39;]= 50</span>
                    <span class="c1"># round_data[&#39;analysis_parameters&#39;][&#39;preprocessing&#39;][&#39;large_obj_removal_selem&#39;] = 3</span>
                    <span class="n">round_data</span><span class="p">[</span><span class="s1">&#39;analysis_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;counting&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">round_data</span><span class="p">[</span><span class="s1">&#39;analysis_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;counting&#39;</span><span class="p">][</span><span class="s1">&#39;min_distance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
                    <span class="n">round_data</span><span class="p">[</span><span class="s1">&#39;analysis_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;counting&#39;</span><span class="p">][</span><span class="s1">&#39;min_obj_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
                    <span class="n">round_data</span><span class="p">[</span><span class="s1">&#39;analysis_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;counting&#39;</span><span class="p">][</span><span class="s1">&#39;max_obj_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">200</span>
                    <span class="n">round_data</span><span class="p">[</span><span class="s1">&#39;analysis_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;beads_registration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_fpath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">new_config</span><span class="p">:</span>
                    <span class="n">yaml</span><span class="o">.</span><span class="n">safe_dump</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">img_config_dict</span><span class="p">),</span> <span class="n">new_config</span><span class="p">,</span><span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Function used to batch modify the values of the
processing parameters in the images_config.yaml
files</p>

<h2 id="parameters">Parameters:</h2>

<p>experiment_fpath: str
    path of the experiment to process
keyword: str
    selection criteria used to process a subset of
    configuration files</p>
</div>


                </section>
                <section id="create_stringency_selection_fov_yaml">
                            <div class="attr function"><a class="headerlink" href="#create_stringency_selection_fov_yaml">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">create_stringency_selection_fov_yaml</span><span class="signature">(pipeline_config_fpath)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">create_stringency_selection_fov_yaml</span><span class="p">(</span><span class="n">pipeline_config_fpath</span><span class="p">):</span>
    
    <span class="n">pipeline_config_dict</span> <span class="o">=</span> <span class="n">load_pipeline_config_file</span><span class="p">(</span><span class="n">pipeline_config_fpath</span><span class="p">)</span>
    <span class="n">fovs</span> <span class="o">=</span> <span class="p">(</span><span class="n">pipeline_config_dict</span><span class="p">[</span><span class="s1">&#39;channel_coords_dict&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">stringency</span> <span class="o">=</span> <span class="n">pipeline_config_dict</span><span class="p">[</span><span class="s1">&#39;pipeline_required_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;counting_settings&#39;</span><span class="p">][</span><span class="s1">&#39;stringency&#39;</span><span class="p">]</span>
    <span class="n">pipeline_config_dict</span><span class="p">[</span><span class="s1">&#39;pipeline_required_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;counting_settings&#39;</span><span class="p">][</span><span class="s1">&#39;stringency&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">pipeline_config_dict</span><span class="p">[</span><span class="s1">&#39;pipeline_required_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;counting_settings&#39;</span><span class="p">][</span><span class="s1">&#39;stringency&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="n">stringency</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">fovs</span><span class="p">}</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pipeline_config_fpath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">new_config</span><span class="p">:</span>
            <span class="n">yaml</span><span class="o">.</span><span class="n">safe_dump</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">pipeline_config_dict</span><span class="p">),</span> <span class="n">new_config</span><span class="p">,</span><span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

        </details>

    

                </section>
                <section id="create_specific_fov_counting_thr_yaml">
                            <div class="attr function"><a class="headerlink" href="#create_specific_fov_counting_thr_yaml">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">create_specific_fov_counting_thr_yaml</span><span class="signature">(pipeline_config_fpath)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">create_specific_fov_counting_thr_yaml</span><span class="p">(</span><span class="n">pipeline_config_fpath</span><span class="p">):</span>
    <span class="n">pipeline_config_dict</span> <span class="o">=</span> <span class="n">load_pipeline_config_file</span><span class="p">(</span><span class="n">pipeline_config_fpath</span><span class="p">)</span>
    <span class="n">fovs</span> <span class="o">=</span> <span class="p">(</span><span class="n">pipeline_config_dict</span><span class="p">[</span><span class="s1">&#39;channel_coords_dict&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">stringency</span> <span class="o">=</span> <span class="n">pipeline_config_dict</span><span class="p">[</span><span class="s1">&#39;pipeline_required_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;counting_settings&#39;</span><span class="p">][</span><span class="s1">&#39;thr_fov&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">pipeline_config_dict</span><span class="p">[</span><span class="s1">&#39;pipeline_required_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;counting_settings&#39;</span><span class="p">][</span><span class="s1">&#39;thr_fov&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="kc">None</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">fovs</span><span class="p">}</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pipeline_config_fpath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">new_config</span><span class="p">:</span>
            <span class="n">yaml</span><span class="o">.</span><span class="n">safe_dump</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">pipeline_config_dict</span><span class="p">),</span> <span class="n">new_config</span><span class="p">,</span><span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

        </details>

    

                </section>
                <section id="select_dir">
                            <div class="attr function"><a class="headerlink" href="#select_dir">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">select_dir</span><span class="signature">(processing_directory, keyword)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">select_dir</span><span class="p">(</span><span class="n">processing_directory</span><span class="p">,</span><span class="n">keyword</span><span class="p">):</span>
    <span class="n">list_hyb_fpaths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">processed_dirs</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">processing_directory</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">keyword</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">dir_name</span> <span class="ow">in</span> <span class="n">processed_dirs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">dir_name</span><span class="p">:</span>
                <span class="n">dir_path</span> <span class="o">=</span> <span class="n">processing_directory</span> <span class="o">/</span> <span class="n">dir_name</span>
                <span class="n">list_hyb_fpaths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">dir_name</span> <span class="ow">in</span> <span class="n">processed_dirs</span><span class="p">:</span>
            <span class="n">dir_path</span> <span class="o">=</span> <span class="n">processing_directory</span> <span class="o">/</span> <span class="n">dir_name</span>
            <span class="n">list_hyb_fpaths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">list_hyb_fpaths</span>
</pre></div>

        </details>

    

                </section>
                <section id="OptionEatAll">
                                <div class="attr class">
        <a class="headerlink" href="#OptionEatAll">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">OptionEatAll</span><wbr>(<span class="base">click.core.Option</span>):
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">OptionEatAll</span><span class="p">(</span><span class="n">click</span><span class="o">.</span><span class="n">Option</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    https://stackoverflow.com/questions/48391777/nargs-equivalent-for-options-in-click</span>

<span class="sd">    Option class to ingest undefined number of options.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_other_options</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;save_other_options&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">nargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;nargs&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">nargs</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;nargs, if set, must be -1 not </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nargs</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">OptionEatAll</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_previous_parser_process</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_eat_all_parser</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">add_to_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">parser_process</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
            <span class="c1"># method to hook to the parser.process</span>
            <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_other_options</span><span class="p">:</span>
                <span class="c1"># grab everything up to the next option</span>
                <span class="k">while</span> <span class="n">state</span><span class="o">.</span><span class="n">rargs</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eat_all_parser</span><span class="o">.</span><span class="n">prefixes</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">rargs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
                            <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
                        <span class="n">value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">rargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># grab everything remaining</span>
                <span class="n">value</span> <span class="o">+=</span> <span class="n">state</span><span class="o">.</span><span class="n">rargs</span>
                <span class="n">state</span><span class="o">.</span><span class="n">rargs</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="c1"># call the actual process</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_previous_parser_process</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>

        <span class="n">retval</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">OptionEatAll</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">add_to_parser</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">:</span>
            <span class="n">our_parser</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">_long_opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">or</span> <span class="n">parser</span><span class="o">.</span><span class="n">_short_opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">our_parser</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_eat_all_parser</span> <span class="o">=</span> <span class="n">our_parser</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_previous_parser_process</span> <span class="o">=</span> <span class="n">our_parser</span><span class="o">.</span><span class="n">process</span>
                <span class="n">our_parser</span><span class="o">.</span><span class="n">process</span> <span class="o">=</span> <span class="n">parser_process</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">retval</span>
</pre></div>

        </details>

            <div class="docstring"><p>https://stackoverflow.com/questions/48391777/nargs-equivalent-for-options-in-click</p>

<p>Option class to ingest undefined number of options.</p>
</div>


                            <div id="OptionEatAll.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#OptionEatAll.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">OptionEatAll</span><span class="signature">(*args, **kwargs)</span>
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_other_options</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;save_other_options&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">nargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;nargs&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">nargs</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;nargs, if set, must be -1 not </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nargs</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">OptionEatAll</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_previous_parser_process</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_eat_all_parser</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="OptionEatAll.add_to_parser" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#OptionEatAll.add_to_parser">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">add_to_parser</span><span class="signature">(self, parser, ctx)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">add_to_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">parser_process</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
            <span class="c1"># method to hook to the parser.process</span>
            <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_other_options</span><span class="p">:</span>
                <span class="c1"># grab everything up to the next option</span>
                <span class="k">while</span> <span class="n">state</span><span class="o">.</span><span class="n">rargs</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eat_all_parser</span><span class="o">.</span><span class="n">prefixes</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">rargs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
                            <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
                        <span class="n">value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">rargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># grab everything remaining</span>
                <span class="n">value</span> <span class="o">+=</span> <span class="n">state</span><span class="o">.</span><span class="n">rargs</span>
                <span class="n">state</span><span class="o">.</span><span class="n">rargs</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="c1"># call the actual process</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_previous_parser_process</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>

        <span class="n">retval</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">OptionEatAll</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">add_to_parser</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">:</span>
            <span class="n">our_parser</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">_long_opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">or</span> <span class="n">parser</span><span class="o">.</span><span class="n">_short_opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">our_parser</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_eat_all_parser</span> <span class="o">=</span> <span class="n">our_parser</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_previous_parser_process</span> <span class="o">=</span> <span class="n">our_parser</span><span class="o">.</span><span class="n">process</span>
                <span class="n">our_parser</span><span class="o">.</span><span class="n">process</span> <span class="o">=</span> <span class="n">parser_process</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">retval</span>
</pre></div>

        </details>

    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>click.core.Option</dt>
                                <dd id="OptionEatAll.param_type_name" class="variable">param_type_name</dd>
                <dd id="OptionEatAll.get_help_record" class="function">get_help_record</dd>
                <dd id="OptionEatAll.get_default" class="function">get_default</dd>
                <dd id="OptionEatAll.prompt_for_value" class="function">prompt_for_value</dd>
                <dd id="OptionEatAll.resolve_envvar_value" class="function">resolve_envvar_value</dd>
                <dd id="OptionEatAll.value_from_envvar" class="function">value_from_envvar</dd>
                <dd id="OptionEatAll.full_process_value" class="function">full_process_value</dd>

            </div>
            <div><dt>click.core.Parameter</dt>
                                <dd id="OptionEatAll.human_readable_name" class="variable">human_readable_name</dd>
                <dd id="OptionEatAll.make_metavar" class="function">make_metavar</dd>
                <dd id="OptionEatAll.consume_value" class="function">consume_value</dd>
                <dd id="OptionEatAll.type_cast_value" class="function">type_cast_value</dd>
                <dd id="OptionEatAll.process_value" class="function">process_value</dd>
                <dd id="OptionEatAll.value_is_missing" class="function">value_is_missing</dd>
                <dd id="OptionEatAll.handle_parse_result" class="function">handle_parse_result</dd>
                <dd id="OptionEatAll.get_usage_pieces" class="function">get_usage_pieces</dd>
                <dd id="OptionEatAll.get_error_hint" class="function">get_error_hint</dd>

            </div>
                                </dl>
                            </div>
                </section>
    </main>
</body>
</html>